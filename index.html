<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adivinhe o N√∫mero</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- ATUALIZADO: Usando a vers√£o 12.4.0 do Firebase SDK (Modular Imports) -->
    <script type="module" src="https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js"></script>

    <style>
        /* Define a fonte Inter e estiliza√ß√£o de foco */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        
        /* Cor de foco alterada para o novo 'accent' dourado */
        input:focus, button:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(251, 191, 36, 0.5); /* Cor Gold/Amber mais brilhante */
        }
        
        body {
            min-height: 100vh;
            margin: 0;
            background-color: #0f172a; /* Fundo AZUL ESCURO PROFUNDO (Slate 900) */
            font-family: 'Inter', sans-serif;
        }
        
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.7);
        }

        /* Estilo para que o cursor de texto nos inputs seja branco */
        input {
            caret-color: white;
        }
        
        /* Estilo para abas de autentica√ß√£o */
        .auth-tab {
            cursor: pointer;
            transition: all 0.2s;
        }
        .auth-tab.active {
            border-bottom: 3px solid #fbbf24;
            color: white;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary-bg': '#1e293b',  /* Base do card (Slate 800) */
                        'accent': '#fbbf24',      /* Gold/Amber CLARO para elementos ativos */
                        'win': '#f59e0b',         /* Darker Amber para sucesso */
                        'lose': '#ef4444',        /* Red para falha/erro */
                    }
                }
            }
        }
    </script>
</head>
<body class="flex flex-col lg:flex-row items-start justify-center p-4 gap-8">

    <div id="auth-panel" class="w-full max-w-xs sm:max-w-sm bg-primary-bg p-6 rounded-xl shadow-2xl border border-gray-700 order-1 lg:order-1">
        <h2 class="text-2xl font-bold text-white mb-4 text-center">üîê Acesso ao Placar</h2>
        
        <div id="authStatusContainer" class="p-4 rounded-lg bg-gray-700 mb-4 text-center">
            <div id="loggedInStatus" class="hidden">
                <p class="text-gray-300 text-sm mb-2">Logado como:</p>
                <p id="userEmailDisplay" class="text-accent font-bold truncate text-lg"></p>
                <button
                    id="signOutButton"
                    class="mt-3 w-full py-2 text-sm font-bold text-primary-bg bg-lose hover:bg-red-600 rounded-lg transition duration-200"
                >
                    Sair (Sign Out)
                </button>
            </div>
            
            <div id="loggedOutStatus" class="text-gray-400">
                <p id="authMessage" class="font-medium">Fa√ßa login ou registre-se para jogar e salvar seu recorde!</p>
            </div>
        </div>

        <div id="authForms" class="space-y-4">
            <div class="flex border-b border-gray-700 mb-4 text-sm font-medium">
                <div id="loginTab" class="auth-tab active flex-1 py-2 text-center text-gray-400">Login</div>
                <div id="registerTab" class="auth-tab flex-1 py-2 text-center text-gray-400">Registrar</div>
                <div id="magicLinkTab" class="auth-tab flex-1 py-2 text-center text-gray-400">Link M√°gico</div>
            </div>

            <form id="loginForm" class="space-y-4">
                <input type="email" id="loginEmail" placeholder="Email" class="w-full p-3 rounded-lg border-2 border-gray-600 bg-gray-700 text-white placeholder-gray-400">
                <input type="password" id="loginPassword" placeholder="Senha" class="w-full p-3 rounded-lg border-2 border-gray-600 bg-gray-700 text-white placeholder-gray-400">
                <button type="submit" class="w-full px-6 py-3 text-lg font-bold text-primary-bg bg-accent hover:bg-win rounded-lg transition duration-200">
                    Entrar
                </button>
                <p id="loginError" class="text-lose text-center text-sm font-medium hidden"></p>
                <div id="forgotPasswordLink" class="text-center text-sm text-gray-400 hover:text-accent cursor-pointer pt-2">Esqueceu a Senha?</div>
            </form>

            <form id="registerForm" class="space-y-4 hidden">
                <input type="email" id="registerEmail" placeholder="Email" class="w-full p-3 rounded-lg border-2 border-gray-600 bg-gray-700 text-white placeholder-gray-400">
                <input type="password" id="registerPassword" placeholder="Senha (m√≠n. 6 caracteres)" class="w-full p-3 rounded-lg border-2 border-gray-600 bg-gray-700 text-white placeholder-gray-400">
                <button type="submit" class="w-full px-6 py-3 text-lg font-bold text-primary-bg bg-accent hover:bg-win rounded-lg transition duration-200">
                    Criar Conta
                </button>
                <p id="registerError" class="text-lose text-center text-sm font-medium hidden"></p>
            </form>

            <form id="magicLinkForm" class="space-y-4 hidden">
                <p class="text-gray-400 text-sm">Insira seu email. Enviaremos um link de login seguro, sem necessidade de senha.</p>
                <input type="email" id="magicLinkEmail" placeholder="Seu Email" class="w-full p-3 rounded-lg border-2 border-gray-600 bg-gray-700 text-white placeholder-gray-400">
                <button type="submit" class="w-full px-6 py-3 text-lg font-bold text-primary-bg bg-green-500 hover:bg-green-600 rounded-lg transition duration-200">
                    Enviar Link de Login
                </button>
                <p id="magicLinkMessage" class="text-center text-sm font-medium hidden"></p>
            </form>

            <form id="resetForm" class="space-y-4 hidden">
                <p class="text-gray-400 text-sm">Insira seu email. Enviaremos um link de recupera√ß√£o.</p>
                <input type="email" id="resetEmail" placeholder="Email de Recupera√ß√£o" class="w-full p-3 rounded-lg border-2 border-gray-600 bg-gray-700 text-white placeholder-gray-400">
                <button type="submit" class="w-full px-6 py-3 text-lg font-bold text-primary-bg bg-blue-500 hover:bg-blue-600 rounded-lg transition duration-200">
                    Enviar Link
                </button>
                <p id="resetMessage" class="text-center text-sm font-medium hidden"></p>
                <div id="backToLoginLink" class="text-center text-sm text-gray-400 hover:text-accent cursor-pointer pt-2">Voltar ao Login</div>
            </form>
        </div>
    </div>


    <div id="game-container" class="w-full max-w-sm bg-primary-bg p-6 rounded-xl shadow-2xl border border-gray-700 order-2 lg:order-2">
        
        <div class="text-center mb-4">
            <span class="text-6xl" style="filter: drop-shadow(0 4px 6px #00000080); color: #fbbf24;">‚ùì</span>
        </div>
        
        <h1 class="text-3xl font-bold text-white mb-2 text-center">Adivinhe o N√∫mero!</h1>
        <p class="text-gray-400 mb-6 text-center">Tente adivinhar o n√∫mero secreto entre 1 e 100.</p>

        <div id="gameLockedMessage" class="p-4 rounded-lg bg-red-800 text-white text-center font-bold mb-6">
            FA√áA LOGIN PARA JOGAR E SALVAR SEU RECORD.
        </div>
        
        <div id="gameContent" class="hidden">
            <div id="input-area" class="flex flex-col sm:flex-row gap-3 mb-6">
                <input
                    type="number"
                    id="guessInput"
                    placeholder="Seu palpite (1-100)"
                    min="1"
                    max="100"
                    class="flex-grow p-3 text-lg rounded-lg border-2 border-gray-600 bg-gray-700 text-white placeholder-gray-400 transition duration-200"
                >
                <button
                    id="checkButton"
                    class="w-full sm:w-auto px-6 py-3 text-lg font-bold text-primary-bg bg-accent hover:bg-win rounded-lg shadow-md transition duration-200 transform hover:scale-105 disabled:opacity-50"
                >
                    Verificar
                </button>
            </div>

            <div class="space-y-4">
                <div id="message" class="p-4 rounded-lg text-center font-semibold text-lg bg-gray-700 text-gray-300 min-h-[4rem] flex items-center justify-center transition duration-300">
                    Digite um n√∫mero e clique em Verificar!
                </div>
                
                <div class="flex justify-between items-center text-gray-400 font-medium pt-2">
                    <span class="text-lg">Tentativas Restantes:</span>
                    <span id="attempts" class="text-3xl font-bold text-accent">10</span>
                </div>
                
                <div class="flex justify-between items-center text-gray-400 font-medium border-t border-gray-700 pt-4">
                    <span class="text-lg">Tempo Gasto:</span>
                    <span id="timerDisplay" class="text-3xl font-bold text-accent">0s</span>
                </div>
            </div>

            <button
                id="resetButton"
                class="hidden w-full mt-6 px-6 py-3 text-lg font-bold text-white bg-blue-500 hover:bg-blue-600 rounded-lg shadow-md transition duration-200 transform hover:scale-105"
            >
                Jogar Novamente
            </button>

            <p id="error-message" class="text-lose text-center mt-3 hidden font-medium">
                Por favor, insira um n√∫mero v√°lido entre 1 e 100.
            </p>
        </div>
    </div>


    <div class="w-full max-w-xs sm:max-w-sm bg-primary-bg p-6 rounded-xl shadow-2xl border border-gray-700 order-3 lg:order-3">
        <h2 class="text-2xl font-bold text-white mb-1 text-center">üèÜ Placar Global</h2>
        <p id="currentUserId" class="text-xs text-gray-500 text-center mb-4 truncate">
            Status: Conectando ao Firebase...
        </p>
        
        <div id="leaderboardContainer" class="space-y-2">
            <div id="loadingMessage" class="text-gray-400 text-center">Carregando placar...</div>
        </div>
        <p id="leaderboardError" class="text-lose text-center mt-1 hidden"></p>
    </div>


    <div id="scoreModal" class="hidden modal-overlay fixed inset-0 flex items-center justify-center z-50">
        <div class="bg-primary-bg p-8 rounded-xl shadow-2xl w-full max-w-sm m-4 transform transition-all duration-300 scale-100">
            <h2 class="text-3xl font-bold text-win mb-4 text-center">Novo Recorde! üéâ</h2>
            <p id="modalMessage" class="text-gray-300 mb-6 text-center">Voc√™ conseguiu em X tentativas. Insira seu nickname para salvar seu feito no Placar Global!</p>
            
            <div id="modalStatusMessage" class="text-center text-sm font-medium min-h-[1.5rem] mb-2 text-gray-400"></div>

            <input
                type="text"
                id="nicknameInput"
                placeholder="Seu Nickname"
                maxlength="12"
                class="w-full p-3 text-lg rounded-lg border-2 border-accent bg-gray-700 text-white placeholder-gray-400 mb-4 transition duration-200"
            >
            <button
                id="saveScoreButton"
                class="w-full px-6 py-3 text-lg font-bold text-primary-bg bg-accent hover:bg-win rounded-lg shadow-md transition duration-200 transform hover:scale-105 disabled:opacity-50"
            >
                Salvar Recorde!
            </button>
            <button
                id="closeModalButton"
                class="w-full mt-3 px-6 py-3 text-sm font-bold text-gray-400 hover:text-white transition duration-200"
            >
                Jogar Novamente (N√£o salvar)
            </button>
        </div>
    </div>


    <script type="module">
        // =========================================================================
        // 1. IMPORTA√á√ïES E CONFIGURA√á√ÉO FIREBASE
        // =========================================================================
        // **IMPORTANTE:** As URLs do SDK foram atualizadas para a vers√£o 12.4.0
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, sendPasswordResetEmail, sendSignInLinkToEmail, isSignInWithEmailLink, signInWithEmailLink } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
        import { getFirestore, addDoc, onSnapshot, collection, query, limit, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

        // CONFIGURA√á√ÉO ATUALIZADA DO SEU NOVO PROJETO FIREBASE (acerteonumero-v2)
        const firebaseConfig = {
            apiKey: "AIzaSyADfUsXQwICBO3u6JLVIZveyNQmVfIi-lM",
            authDomain: "acerteonumero-v2.firebaseapp.com",
            projectId: "acerteonumero-v2",
            storageBucket: "acerteonumero-v2.firebasestorage.app",
            messagingSenderId: "180559249457",
            appId: "1:180559249457:web:3757e65c19a7094d75d510",
            measurementId: "G-E76PVZRSTR"
        };
        
        // =========================================================================
        // 2. VARI√ÅVEIS GLOBAIS E INICIALIZA√á√ÉO
        // =========================================================================

        let db;
        let auth;
        let userId = null; // ID do usu√°rio logado (UID do Firebase)
        let currentUser = null; // Objeto user do Firebase
        let isAuthReady = false; 
        let isLeaderboardActive = false; 
        let currentAuthMode = 'login'; 

        // Vari√°veis globais do jogo
        let secretNumber;
        let attemptsMade;
        const maxAttempts = 10;
        let isGameActive = false;
        
        // Vari√°veis para o Timer (Performance)
        let gameTimer;
        let timeElapsed;
        let gameStartTime;

        // Refer√™ncias DOM - JOGO
        const guessInput = document.getElementById('guessInput');
        const checkButton = document.getElementById('checkButton');
        const resetButton = document.getElementById('resetButton');
        const messageDisplay = document.getElementById('message');
        const attemptsDisplay = document.getElementById('attempts');
        const errorDisplay = document.getElementById('error-message');
        const timerDisplay = document.getElementById('timerDisplay');
        const gameContent = document.getElementById('gameContent');
        const gameLockedMessage = document.getElementById('gameLockedMessage');

        // Refer√™ncias DOM - AUTENTICA√á√ÉO
        const loggedInStatus = document.getElementById('loggedInStatus');
        const loggedOutStatus = document.getElementById('loggedOutStatus');
        const userEmailDisplay = document.getElementById('userEmailDisplay');
        const signOutButton = document.getElementById('signOutButton');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const magicLinkForm = document.getElementById('magicLinkForm');
        const resetForm = document.getElementById('resetForm');
        const loginTab = document.getElementById('loginTab');
        const registerTab = document.getElementById('registerTab');
        const magicLinkTab = document.getElementById('magicLinkTab');
        const loginError = document.getElementById('loginError');
        const registerError = document.getElementById('registerError');
        const forgotPasswordLink = document.getElementById('forgotPasswordLink');
        const backToLoginLink = document.getElementById('backToLoginLink');
        const resetMessage = document.getElementById('resetMessage');
        const magicLinkMessage = document.getElementById('magicLinkMessage');

        // Refer√™ncias DOM - PLACAR e MODAL
        const leaderboardContainer = document.getElementById('leaderboardContainer');
        const scoreModal = document.getElementById('scoreModal');
        const modalMessage = document.getElementById('modalMessage');
        const nicknameInput = document.getElementById('nicknameInput');
        const saveScoreButton = document.getElementById('saveScoreButton');
        const closeModalButton = document.getElementById('closeModalButton');
        const loadingMessage = document.getElementById('loadingMessage');
        const currentUserIdDisplay = document.getElementById('currentUserId');
        const modalStatusMessage = document.getElementById('modalStatusMessage');


        function initFirebase() {
            // Inicializa o Firebase
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Observa o estado de autentica√ß√£o para atualizar a UI
                onAuthStateChanged(auth, handleAuthStateChange);

                // Checa se √© um retorno de link m√°gico
                handleMagicLinkSignIn();

            } catch (error) {
                console.error("Erro ao inicializar Firebase:", error);
                currentUserIdDisplay.textContent = "Erro de Configura√ß√£o. Verifique as chaves do Firebase.";
            }
        }

        // =========================================================================
        // 3. L√ìGICA DE AUTENTICA√á√ÉO
        // =========================================================================

        function handleAuthStateChange(user) {
            isAuthReady = true;
            if (user) {
                // Logado
                userId = user.uid;
                currentUser = user;
                userEmailDisplay.textContent = user.email;
                loggedInStatus.classList.remove('hidden');
                loggedOutStatus.classList.add('hidden');
                gameContent.classList.remove('hidden');
                gameLockedMessage.classList.add('hidden');
                currentUserIdDisplay.textContent = `Logado: ${user.email}`;

                // Ativa o Placar se ainda n√£o estiver ativo
                if (!isLeaderboardActive) {
                    subscribeToLeaderboard();
                }
                // Garante que o jogo comece se n√£o estiver ativo
                if (!isGameActive) {
                    initGame(); 
                }
            } else {
                // Deslogado
                userId = null;
                currentUser = null;
                loggedInStatus.classList.add('hidden');
                loggedOutStatus.classList.remove('hidden');
                gameContent.classList.add('hidden');
                gameLockedMessage.classList.remove('hidden');
                currentUserIdDisplay.textContent = "Status: Deslogado. Login para salvar o recorde.";
            }
        }

        function switchAuthMode(mode) {
            currentAuthMode = mode;
            loginForm.classList.add('hidden');
            registerForm.classList.add('hidden');
            magicLinkForm.classList.add('hidden');
            resetForm.classList.add('hidden');
            loginTab.classList.remove('active');
            registerTab.classList.remove('active');
            magicLinkTab.classList.remove('active');
            forgotPasswordLink.classList.remove('hidden');
            resetMessage.classList.add('hidden');
            loginError.classList.add('hidden');
            registerError.classList.add('hidden');
            magicLinkMessage.classList.add('hidden');

            if (mode === 'login') {
                loginForm.classList.remove('hidden');
                loginTab.classList.add('active');
            } else if (mode === 'register') {
                registerForm.classList.remove('hidden');
                registerTab.classList.add('active');
            } else if (mode === 'magiclink') {
                magicLinkForm.classList.remove('hidden');
                magicLinkTab.classList.add('active');
                forgotPasswordLink.classList.add('hidden'); // Oculta o link de senha no modo Magic Link
            } else if (mode === 'reset') {
                resetForm.classList.remove('hidden');
                forgotPasswordLink.classList.add('hidden');
                loginTab.classList.add('active'); // Mant√©m o destaque na aba de login
            }
        }

        loginTab.addEventListener('click', () => switchAuthMode('login'));
        registerTab.addEventListener('click', () => switchAuthMode('register'));
        magicLinkTab.addEventListener('click', () => switchAuthMode('magiclink'));
        forgotPasswordLink.addEventListener('click', () => switchAuthMode('reset'));
        backToLoginLink.addEventListener('click', () => switchAuthMode('login'));


        // L√≥gica de Registro (E-mail e Senha)
        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            registerError.classList.add('hidden');

            try {
                await createUserWithEmailAndPassword(auth, email, password);
                // Redireciona para o login ou simplesmente a mudan√ßa de estado (onAuthStateChanged) cuida disso
            } catch (error) {
                console.error(error);
                let msg = 'Erro ao criar conta. Tente novamente.';
                if (error.code === 'auth/weak-password') {
                    msg = 'Senha fraca. Deve ter pelo menos 6 caracteres.';
                } else if (error.code === 'auth/email-already-in-use') {
                    msg = 'Este e-mail j√° est√° em uso.';
                } else if (error.code === 'auth/invalid-email') {
                    msg = 'Formato de e-mail inv√°lido.';
                }
                registerError.textContent = msg;
                registerError.classList.remove('hidden');
            }
        });

        // L√≥gica de Login (E-mail e Senha)
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            loginError.classList.add('hidden');

            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error(error);
                let msg = 'Erro ao fazer login. Verifique o e-mail e a senha.';
                if (error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') {
                    msg = 'Credenciais inv√°lidas.';
                }
                loginError.textContent = msg;
                loginError.classList.remove('hidden');
            }
        });
        
        // L√≥gica de Sign Out
        signOutButton.addEventListener('click', async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Erro ao sair:", error);
            }
        });

        // L√≥gica de Link M√°gico (Passwordless)
        magicLinkForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('magicLinkEmail').value;
            magicLinkMessage.classList.add('hidden');
            
            // actionCodeSettings deve ter o dom√≠nio do seu site Netlify na URL (dom√≠nio autorizado)
            const actionCodeSettings = {
                url: window.location.href, // Usa o URL atual do Netlify
                handleCodeInApp: true,
            };

            try {
                await sendSignInLinkToEmail(auth, email, actionCodeSettings);
                window.localStorage.setItem('emailForSignIn', email);
                magicLinkMessage.textContent = `Link de login enviado para ${email}. Verifique sua caixa de entrada e clique no link para entrar!`;
                magicLinkMessage.classList.remove('hidden');
                magicLinkMessage.classList.remove('text-lose');
                magicLinkMessage.classList.add('text-accent');
            } catch (error) {
                console.error("Erro Magic Link:", error);
                magicLinkMessage.textContent = 'Erro ao enviar o link. Verifique o e-mail e tente novamente.';
                magicLinkMessage.classList.remove('hidden');
                magicLinkMessage.classList.add('text-lose');
            }
        });

        // Fun√ß√£o que verifica e finaliza o Login por Link M√°gico
        async function handleMagicLinkSignIn() {
            if (isSignInWithEmailLink(auth, window.location.href)) {
                let email = window.localStorage.getItem('emailForSignIn');
                if (!email) {
                    // Pede o e-mail novamente se o usu√°rio abriu em outro dispositivo
                    email = window.prompt('Por favor, confirme seu e-mail para finalizar o login.');
                }
                
                try {
                    await signInWithEmailLink(auth, email, window.location.href);
                    window.localStorage.removeItem('emailForSignIn');
                    // O estado de autentica√ß√£o ser√° atualizado por onAuthStateChanged
                } catch (error) {
                    // Use a div para mensagens, pois alert() √© ruim para UX
                    document.getElementById('authMessage').textContent = `Erro ao completar o login por link: ${error.message}. Tente novamente.`;
                    document.getElementById('authMessage').classList.add('text-lose');
                    window.history.replaceState({}, document.title, window.location.pathname); // Limpa o URL
                }
            }
        }

        // L√≥gica de Reset de Senha
        resetForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('resetEmail').value;
            resetMessage.classList.add('hidden');

            try {
                await sendPasswordResetEmail(auth, email);
                resetMessage.textContent = 'Link de recupera√ß√£o enviado para o seu e-mail.';
                resetMessage.classList.remove('hidden');
                resetMessage.classList.remove('text-lose');
                resetMessage.classList.add('text-accent');
            } catch (error) {
                console.error("Erro Reset Senha:", error);
                resetMessage.textContent = 'Erro ao enviar. Verifique se o e-mail est√° correto.';
                resetMessage.classList.remove('hidden');
                resetMessage.classList.add('text-lose');
            }
        });

        // =========================================================================
        // 4. L√ìGICA DO PLACAR (FIRESTORE)
        // =========================================================================

        async function saveScore(nickname, attempts, time) {
            if (!userId || !db) {
                modalStatusMessage.textContent = "Erro: Usu√°rio n√£o logado ou Firebase desconectado.";
                modalStatusMessage.classList.add('text-lose');
                return;
            }

            // Garante que o nickname n√£o √© vazio e est√° dentro do limite
            if (!nickname || nickname.length > 12) {
                modalStatusMessage.textContent = "Erro: Nickname inv√°lido.";
                modalStatusMessage.classList.add('text-lose');
                return;
            }

            try {
                await addDoc(collection(db, "leaderboard"), {
                    userId: userId,
                    nickname: nickname,
                    attempts: attempts,
                    time: time,
                    timestamp: serverTimestamp()
                });
                
                modalStatusMessage.textContent = "Recorde salvo com sucesso!";
                modalStatusMessage.classList.remove('text-lose');
                modalStatusMessage.classList.add('text-win');
                saveScoreButton.disabled = true;
                nicknameInput.disabled = true;
            } catch (error) {
                console.error("Erro ao salvar recorde:", error);
                modalStatusMessage.textContent = "Erro ao salvar recorde no Firebase.";
                modalStatusMessage.classList.add('text-lose');
                saveScoreButton.disabled = false;
            }
        }

        function renderLeaderboard(scores) {
            leaderboardContainer.innerHTML = '';
            loadingMessage.classList.add('hidden');
            
            if (scores.length === 0) {
                leaderboardContainer.innerHTML = '<p class="text-gray-400 text-center">Nenhum recorde ainda. Seja o primeiro!</p>';
                return;
            }

            scores.forEach((score, index) => {
                const isCurrentUser = score.userId === userId;
                const item = document.createElement('div');
                item.className = `p-3 rounded-lg flex justify-between items-center transition duration-200 ${isCurrentUser ? 'bg-accent/30 border-2 border-accent' : 'bg-gray-700 border border-gray-600'}`;
                
                const rank = index + 1;
                const attemptsText = score.attempts === 1 ? 'tentativa' : 'tentativas';
                const rankText = index < 3 ? 'text-accent font-extrabold' : 'text-gray-300 font-bold';
                
                // Formata o tempo para ter 1 casa decimal
                const timeFormatted = score.time ? score.time.toFixed(1) : '0.0';

                item.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <span class="text-xl ${rankText}">${rank}.</span>
                        <span class="font-medium ${isCurrentUser ? 'text-white' : 'text-gray-200'}">${score.nickname}</span>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-gray-400">${timeFormatted}s</p>
                        <p class="text-xs text-gray-500">${score.attempts} ${attemptsText}</p>
                    </div>
                `;
                leaderboardContainer.appendChild(item);
            });
        }

        function subscribeToLeaderboard() {
            if (!db) return;
            isLeaderboardActive = true;
            
            // Query: Menor n√∫mero de tentativas (asc), depois menor tempo (asc), limitando a 10 resultados
            const q = query(collection(db, "leaderboard"), orderBy("attempts", "asc"), orderBy("time", "asc"), limit(10));

            onSnapshot(q, (snapshot) => {
                const scores = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                renderLeaderboard(scores);
            }, (error) => {
                console.error("Erro ao carregar placar:", error);
                document.getElementById('leaderboardError').textContent = "Erro ao conectar o Placar.";
                document.getElementById('leaderboardError').classList.remove('hidden');
            });
        }


        // =========================================================================
        // 5. L√ìGICA DO JOGO
        // =========================================================================

        function initGame() {
            secretNumber = Math.floor(Math.random() * 100) + 1;
            attemptsMade = 0;
            isGameActive = true;
            timeElapsed = 0;
            gameStartTime = Date.now();
            
            messageDisplay.textContent = 'Digite um n√∫mero e clique em Verificar!';
            messageDisplay.className = 'p-4 rounded-lg text-center font-semibold text-lg bg-gray-700 text-gray-300 min-h-[4rem] flex items-center justify-center transition duration-300';
            attemptsDisplay.textContent = maxAttempts;
            guessInput.value = '';
            guessInput.disabled = false;
            checkButton.disabled = false;
            resetButton.classList.add('hidden');
            errorDisplay.classList.add('hidden');
            timerDisplay.textContent = '0s';

            clearInterval(gameTimer);
            gameTimer = setInterval(updateTimer, 100); // Atualiza a cada 100ms
        }

        function updateTimer() {
            if (isGameActive) {
                timeElapsed = (Date.now() - gameStartTime) / 1000;
                timerDisplay.textContent = `${timeElapsed.toFixed(1)}s`;
            }
        }

        function checkGuess() {
            if (!isGameActive) return;

            const guess = parseInt(guessInput.value);

            if (isNaN(guess) || guess < 1 || guess > 100) {
                errorDisplay.classList.remove('hidden');
                return;
            }

            errorDisplay.classList.add('hidden');
            attemptsMade++;
            const remaining = maxAttempts - attemptsMade;
            attemptsDisplay.textContent = remaining;

            if (guess === secretNumber) {
                endGame(true);
                messageDisplay.textContent = `üéâ Parab√©ns! Voc√™ acertou em ${attemptsMade} tentativas!`;
                messageDisplay.className = 'p-4 rounded-lg text-center font-bold text-lg text-primary-bg bg-win min-h-[4rem] flex items-center justify-center transition duration-300';
            } else if (remaining === 0) {
                endGame(false);
                messageDisplay.textContent = `Game Over! O n√∫mero era ${secretNumber}.`;
                messageDisplay.className = 'p-4 rounded-lg text-center font-bold text-lg text-white bg-lose min-h-[4rem] flex items-center justify-center transition duration-300';
            } else if (guess < secretNumber) {
                messageDisplay.textContent = 'O n√∫mero secreto √© maior. Tente novamente!';
                messageDisplay.className = 'p-4 rounded-lg text-center font-semibold text-lg bg-gray-700 text-gray-300 min-h-[4rem] flex items-center justify-center transition duration-300';
            } else {
                messageDisplay.textContent = 'O n√∫mero secreto √© menor. Tente novamente!';
                messageDisplay.className = 'p-4 rounded-lg text-center font-semibold text-lg bg-gray-700 text-gray-300 min-h-[4rem] flex items-center justify-center transition duration-300';
            }

            guessInput.value = '';
            guessInput.focus();
        }

        function endGame(win) {
            isGameActive = false;
            clearInterval(gameTimer);
            guessInput.disabled = true;
            checkButton.disabled = true;
            resetButton.classList.remove('hidden');

            // Salva apenas se o usu√°rio estiver logado e tiver ganhado
            if (win && userId) {
                showScoreModal(attemptsMade, timeElapsed);
            }
        }

        function showScoreModal(attempts, time) {
            modalMessage.innerHTML = `Voc√™ conseguiu em **${attempts} tentativas** e **${time.toFixed(1)} segundos**!`;
            // Tenta pr√©-preencher o nickname com o nome de exibi√ß√£o, ou parte do email
            const defaultNickname = currentUser?.displayName || currentUser?.email.split('@')[0] || '';
            nicknameInput.value = defaultNickname.substring(0, 12); // Limita a 12 caracteres
            
            // Limpa o estado do modal
            modalStatusMessage.textContent = "";
            modalStatusMessage.classList.remove('text-lose', 'text-win');
            saveScoreButton.disabled = false;
            nicknameInput.disabled = false;
            
            scoreModal.classList.remove('hidden');
        }

        function hideScoreModal() {
            scoreModal.classList.add('hidden');
            initGame();
        }


        // =========================================================================
        // 6. EVENT LISTENERS
        // =========================================================================

        checkButton.addEventListener('click', checkGuess);
        guessInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                checkGuess();
            }
        });
        resetButton.addEventListener('click', initGame);

        saveScoreButton.addEventListener('click', () => {
            const nickname = nicknameInput.value.trim();
            if (nickname) {
                saveScore(nickname, attemptsMade, timeElapsed);
            }
        });

        closeModalButton.addEventListener('click', hideScoreModal);
        
        // =========================================================================
        // 7. INICIALIZA√á√ÉO GERAL
        // =========================================================================
        
        initFirebase(); 

    </script>
</body>
</html>
