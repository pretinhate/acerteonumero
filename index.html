<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Tempo de Rea√ß√£o</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .game-area {
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: 400px;
        }
        .reaction-box {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            font-weight: 800;
            font-size: 1.5rem;
            color: #fff;
            cursor: pointer;
            transition: background-color 0.1s ease-in-out;
            user-select: none;
            padding: 20px;
            border-radius: 12px;
        }
        .reaction-box.ready { background-color: #3b82f6; } /* Blue - Get Ready */
        .reaction-box.wait { background-color: #f59e0b; cursor: not-allowed; } /* Yellow - Wait */
        .reaction-box.go { background-color: #10b981; } /* Green - Click Now */
        .reaction-box.too-soon { background-color: #ef4444; } /* Red - Too Soon */
        .reaction-box.result { background-color: #6366f1; } /* Purple - Result */
        
        @media (min-width: 640px) {
            .reaction-box { font-size: 2.5rem; }
            .container { flex-direction: row; }
            .game-area { flex: 2; }
            .leaderboard-container { flex: 1; }
        }
    </style>
</head>
<body>

    <script src="https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js"></script>
    
    <div class="container">
        
        <!-- √Årea do Jogo -->
        <div class="game-area">
            <div id="reaction-box" class="reaction-box ready" onclick="handleReactionClick()">
                Clique para Come√ßar
            </div>
        </div>

        <!-- Placar e Status -->
        <div class="leaderboard-container bg-white p-6 rounded-xl shadow-lg flex flex-col gap-4">
            <h2 class="text-2xl font-bold text-gray-800 border-b pb-2">üèÜ Placar Global</h2>
            
            <!-- Status de Autentica√ß√£o -->
            <div id="auth-status" class="text-sm font-semibold p-2 rounded-lg">
                <span class="text-gray-500">Iniciando Firebase...</span>
            </div>

            <!-- Placar -->
            <div id="leaderboard-list" class="flex flex-col gap-3">
                <div class="text-gray-500 italic">Carregando placar...</div>
            </div>
        </div>
    </div>

    <!-- Modal para Nickname (Escondido por padr√£o) -->
    <div id="nickname-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm transform transition-all">
            <h3 class="text-xl font-bold mb-4 text-indigo-600">Primeiro, seu Nickname</h3>
            <p class="text-gray-600 mb-6">Voc√™ precisa de um apelido para aparecer no placar.</p>
            
            <form id="nickname-form" onsubmit="event.preventDefault(); saveNickname();">
                <input type="text" id="nickname-input" placeholder="Seu Nickname (ex: RatoVeloz)" maxlength="20"
                       class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 mb-4" required>
                
                <button type="submit" id="save-nickname-btn"
                        class="w-full bg-indigo-600 text-white p-3 rounded-lg font-semibold hover:bg-indigo-700 transition duration-200">
                    Salvar Nickname
                </button>
            </form>
            <p id="nickname-error" class="text-red-500 text-sm mt-3 hidden"></p>
        </div>
    </div>

    <!-- Modal de Recorde (Escondido por padr√£o) -->
    <div id="score-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm transform transition-all text-center">
            <h3 id="score-modal-title" class="text-2xl font-extrabold mb-2 text-green-600">Novo Recorde!</h3>
            <p id="score-modal-message" class="text-gray-700 mb-6">Parab√©ns! Seu tempo de **XXms** foi salvo.</p>
            
            <button onclick="closeScoreModal()"
                    class="bg-indigo-500 text-white p-3 rounded-lg font-semibold hover:bg-indigo-600 transition duration-200">
                Fechar
            </button>
        </div>
    </div>

    <script type="module">
        // Vari√°veis Globais do Canvas (N√ÉO DELETAR!)
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Importa√ß√µes e Inicializa√ß√£o
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, addDoc, serverTimestamp, orderBy, limit } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore-lite.js";
        
        // Configura√ß√£o Firebase
        let app;
        let db;
        let auth;
        let userId = null;
        let userNickname = null;
        let isAuthReady = false;

        // Caminhos das Cole√ß√µes (CORRIGIDOS PARA SINCRONIZAR COM AS REGRAS DE SEGURAN√áA)
        const LEADERBOARD_COLLECTION_PATH = "leaderboard"; 
        const USER_PROFILE_COLLECTION_PATH = "users";
        
        setLogLevel('debug'); // Ativar logs de debug para o Firestore

        // Vari√°veis do Jogo
        const reactionBox = document.getElementById('reaction-box');
        let startTime, endTime;
        let isWaiting = false;
        let isGo = false;
        let timerId;
        const MIN_WAIT = 1500; // 1.5 segundos
        const MAX_WAIT = 4000; // 4 segundos

        // =================================================================================
        // FUN√á√ïES DE UTILIDADE E UI
        // =================================================================================
        
        function updateAuthStatus(status, colorClass) {
            const authStatusElement = document.getElementById('auth-status');
            authStatusElement.textContent = status;
            authStatusElement.className = `text-sm font-semibold p-2 rounded-lg ${colorClass}`;
        }

        function showModal(id) {
            document.getElementById(id).classList.remove('hidden');
        }

        function hideModal(id) {
            document.getElementById(id).classList.add('hidden');
        }
        
        // =================================================================================
        // FUN√á√ïES DE AUTENTICA√á√ÉO E FIRESTORE (INICIALIZA√á√ÉO)
        // =================================================================================

        async function initFirebase() {
            if (!firebaseConfig.apiKey) {
                updateAuthStatus("Erro: Configura√ß√£o do Firebase ausente.", "bg-red-100 text-red-600");
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        updateAuthStatus(`Logado como: ${user.email || 'Usu√°rio An√¥nimo'}`, "bg-green-100 text-green-600");
                        await checkUserProfile();
                        isAuthReady = true;
                        if (userNickname) {
                           setupLeaderboardListener();
                        }
                    } else {
                        // Tentar login com Custom Token fornecido pelo Canvas (preferido)
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            // Se n√£o houver token, fazer login anonimamente
                            await signInAnonymously(auth);
                        }
                        // O onAuthStateChanged ser√° chamado novamente com o usu√°rio logado
                    }
                });

            } catch (error) {
                console.error("Erro ao iniciar Firebase:", error);
                updateAuthStatus(`Erro de Inicializa√ß√£o: ${error.message}`, "bg-red-100 text-red-600");
            }
        }

        // =================================================================================
        // FUN√á√ïES DE PERFIL (NICKNAME)
        // =================================================================================
        
        async function checkUserProfile() {
            if (!userId) return;
            
            const profileRef = doc(db, USER_PROFILE_COLLECTION_PATH, userId);
            
            try {
                const profileSnap = await getDoc(profileRef);
                
                if (profileSnap.exists() && profileSnap.data().nickname) {
                    userNickname = profileSnap.data().nickname;
                    updateAuthStatus(`Logado: ${userNickname}`, "bg-green-100 text-green-600");
                    hideModal('nickname-modal');
                } else {
                    userNickname = null;
                    showModal('nickname-modal');
                }
            } catch (error) {
                console.error("Erro ao checar perfil:", error);
                updateAuthStatus("Erro ao carregar perfil. Recarregue.", "bg-red-100 text-red-600");
            }
        }

        async function saveNickname() {
            if (!userId || !db) return;

            const input = document.getElementById('nickname-input');
            const nickname = input.value.trim();
            const errorElement = document.getElementById('nickname-error');
            const button = document.getElementById('save-nickname-btn');

            if (!nickname) return;

            button.textContent = "Salvando...";
            button.disabled = true;
            errorElement.classList.add('hidden');
            
            const profileRef = doc(db, USER_PROFILE_COLLECTION_PATH, userId);

            try {
                await setDoc(profileRef, {
                    nickname: nickname,
                    updatedAt: serverTimestamp()
                }, { merge: true });

                userNickname = nickname;
                updateAuthStatus(`Logado: ${userNickname}`, "bg-green-100 text-green-600");
                
                // Oculta o modal e inicia o listener do placar
                hideModal('nickname-modal');
                setupLeaderboardListener(); 

            } catch (error) {
                console.error("Erro ao salvar nickname:", error);
                errorElement.textContent = `Falha ao salvar. Tente novamente. Erro: ${error.message}`;
                errorElement.classList.remove('hidden');
            } finally {
                button.textContent = "Salvar Nickname";
                button.disabled = false;
            }
        }

        // =================================================================================
        // FUN√á√ïES DE PLACAR (LEADERBOARD)
        // =================================================================================

        function setupLeaderboardListener() {
            if (!db) {
                console.error("Firestore n√£o inicializado.");
                return;
            }

            const leaderboardCollection = collection(db, LEADERBOARD_COLLECTION_PATH);
            
            // Consulta: 10 melhores scores (menor tempo √© melhor), ordenados por tempo
            // Agora, como a cole√ß√£o s√≥ tem o melhor score de cada user, o ranking fica correto.
            const q = query(leaderboardCollection, orderBy("time_ms"), limit(10));

            // onSnapshot: Atualiza o placar em tempo real
            onSnapshot(q, (snapshot) => {
                const leaderboardList = document.getElementById('leaderboard-list');
                leaderboardList.innerHTML = '';
                
                if (snapshot.empty) {
                    leaderboardList.innerHTML = '<div class="text-gray-500 italic">Nenhum recorde ainda. Seja o primeiro!</div>';
                    return;
                }

                snapshot.forEach((doc, index) => {
                    const data = doc.data();
                    const rank = index + 1;
                    const isCurrentUser = data.userId === userId;
                    
                    const listItem = `
                        <div class="flex justify-between items-center p-3 rounded-lg ${isCurrentUser ? 'bg-indigo-50 border-2 border-indigo-400' : 'bg-gray-50'}">
                            <span class="font-bold text-gray-700">${rank}. ${data.nickname}</span>
                            <span class="font-extrabold ${isCurrentUser ? 'text-indigo-600' : 'text-gray-800'}">${data.time_ms} ms</span>
                        </div>
                    `;
                    leaderboardList.innerHTML += listItem;
                });
            }, (error) => {
                console.error("Erro ao conectar o Placar:", error);
                document.getElementById('leaderboard-list').innerHTML = `
                    <div class="text-red-500 font-bold">Erro ao conectar o Placar. (Verifique as Regras de Seguran√ßa do Firestore!)</div>
                `;
            });
        }

        async function saveScore(time_ms) {
            if (!userNickname) {
                // Se n√£o tiver nickname, pede para salvar antes de tentar salvar o score
                showModal('nickname-modal');
                return;
            }
            if (!db || !userId) return;

            // Define o documento do score usando o pr√≥prio userId como ID do documento.
            // Isso garante que cada usu√°rio ter√° APENAS UM documento no placar.
            const scoreDocRef = doc(db, LEADERBOARD_COLLECTION_PATH, userId);

            try {
                const docSnap = await getDoc(scoreDocRef);
                
                let shouldSave = true;
                
                if (docSnap.exists()) {
                    const currentBestTime = docSnap.data().time_ms;
                    // Se o novo tempo for MAIOR ou IGUAL ao tempo atual, n√£o salva.
                    if (time_ms >= currentBestTime) {
                        shouldSave = false;
                    }
                }
                
                // Vari√°veis para o Modal
                const title = document.getElementById('score-modal-title');
                const message = document.getElementById('score-modal-message');

                if (shouldSave) {
                    // √â um novo recorde pessoal (ou o primeiro score), ent√£o salva/sobrescreve
                    await setDoc(scoreDocRef, {
                        time_ms: time_ms, // Armazena o novo melhor tempo
                        nickname: userNickname,
                        userId: userId,
                        updatedAt: serverTimestamp()
                    });

                    // Exibir modal de sucesso (Novo Recorde)
                    title.textContent = docSnap.exists() ? "NOVO RECORD!" : "Recorde Registrado!";
                    title.className = "text-2xl font-extrabold mb-2 text-green-600";
                    message.innerHTML = `Seu novo melhor tempo de **${time_ms} ms** foi salvo no placar!`;

                } else {
                    // N√£o foi um recorde pessoal
                    const currentBestTime = docSnap.data().time_ms;
                    
                    title.textContent = "Tempo N√£o Registrado";
                    title.className = "text-2xl font-extrabold mb-2 text-yellow-600";
                    message.innerHTML = `Seu tempo de **${time_ms} ms** n√£o superou seu recorde atual de **${currentBestTime} ms**. Tente de novo!`;
                }

                showModal('score-modal');
                
                // Fechar automaticamente ap√≥s 3 segundos para dar tempo de ler o resultado
                setTimeout(closeScoreModal, 3000);

            } catch (error) {
                console.error("Erro ao salvar o score:", error);
                
                // Exibir modal de erro
                const title = document.getElementById('score-modal-title');
                const message = document.getElementById('score-modal-message');
                title.textContent = "Falha ao Salvar";
                title.className = "text-2xl font-extrabold mb-2 text-red-600";
                message.innerHTML = `N√£o foi poss√≠vel salvar seu recorde. Erro: <span class="text-sm text-red-500">${error.message}</span>`;
                showModal('score-modal');
                setTimeout(closeScoreModal, 3000);
            }
        }
        
        function closeScoreModal() {
            hideModal('score-modal');
        }

        // =================================================================================
        // FUN√á√ïES DO JOGO
        // =================================================================================

        function resetGame() {
            clearTimeout(timerId);
            isWaiting = false;
            isGo = false;
            reactionBox.className = 'reaction-box ready';
            reactionBox.textContent = 'Clique para Come√ßar';
        }

        function startGame() {
            if (isWaiting || isGo) return; // N√£o iniciar se j√° estiver rodando

            reactionBox.className = 'reaction-box wait';
            reactionBox.textContent = 'Aguarde o VERDE...';
            isWaiting = true;

            const randomWait = Math.random() * (MAX_WAIT - MIN_WAIT) + MIN_WAIT;
            
            timerId = setTimeout(() => {
                reactionBox.className = 'reaction-box go';
                reactionBox.textContent = 'CLIQUE AGORA!';
                isWaiting = false;
                isGo = true;
                startTime = performance.now();
            }, randomWait);
        }

        function handleReactionClick() {
            if (reactionBox.classList.contains('ready')) {
                // Inicia o jogo
                startGame();
            } else if (reactionBox.classList.contains('wait')) {
                // Clicou muito cedo
                clearTimeout(timerId);
                reactionBox.className = 'reaction-box too-soon';
                reactionBox.textContent = 'Muito Cedo! Clique para Tentar Novamente.';
                isWaiting = false;
                isGo = false;
            } else if (reactionBox.classList.contains('go')) {
                // Clicou na hora certa
                endTime = performance.now();
                const reactionTime = Math.round(endTime - startTime);
                
                reactionBox.className = 'reaction-box result';
                reactionBox.innerHTML = `Seu Tempo: <strong>${reactionTime} ms</strong>. <br> Clique para Tentar Novamente.`;
                
                isWaiting = false;
                isGo = false;
                
                // Salva o score no Firestore
                saveScore(reactionTime);
                
            } else if (reactionBox.classList.contains('too-soon') || reactionBox.classList.contains('result')) {
                // Reinicia o jogo ap√≥s um resultado ou erro
                resetGame();
            }
        }

        // =================================================================================
        // IN√çCIO DA APLICA√á√ÉO
        // =================================================================================
        window.onload = function() {
            initFirebase();
        }
    </script>
</body>
</html>
