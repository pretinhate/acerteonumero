<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ranking Único de Melhor Tempo</title>
    <!-- Carrega Tailwind CSS para estilização rápida e responsiva -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Define a fonte Inter para toda a aplicação */
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        .card { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .ranking-item:nth-child(odd) { background-color: #f0f4f8; }
        .ranking-item:nth-child(even) { background-color: #ffffff; }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1d4ed8',
                        secondary: '#93c5fd',
                    }
                }
            }
        }
    </script>
</head>
<body class="p-4 md:p-8 min-h-screen flex flex-col items-center">

    <!-- Cabeçalho e Informações do Usuário -->
    <div class="w-full max-w-4xl mb-6 bg-white p-4 rounded-xl card border border-gray-100">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">Desafio de Tempo e Ranking Único</h1>
        <p class="text-gray-600 mb-4">Seu objetivo é conseguir o tempo mais baixo. Sua pontuação no ranking só será atualizada se for **melhor** que sua tentativa anterior.</p>
        <p id="auth-status" class="text-sm font-medium text-primary">Carregando autenticação...</p>
        <p id="user-id-display" class="text-xs text-gray-500 mt-1 break-words hidden">ID do Usuário: <span id="user-id-value" class="font-mono bg-gray-100 p-1 rounded"></span></p>
    </div>

    <main class="w-full max-w-4xl grid grid-cols-1 lg:grid-cols-2 gap-6">

        <!-- Área do Jogo/Cronômetro -->
        <div class="bg-white p-6 rounded-xl card border border-gray-100 h-fit">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">Seu Desafio</h2>

            <!-- NOVO: Exibição do Recorde Pessoal/Perfil -->
            <div id="user-record-display" class="mb-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
                <p class="text-sm font-semibold text-blue-700 mb-1">Seu Nome: <span id="profile-username" class="font-bold text-blue-800">Carregando...</span></p>
                <p class="text-lg font-bold text-blue-800">Seu Recorde: <span id="user-best-time-value" class="tabular-nums">--.--</span>s</p>
            </div>
            <!-- Fim NOVO -->

            <div id="game-area" class="text-center p-8 bg-indigo-50 rounded-lg border-2 border-indigo-200">
                <p class="text-xl mb-4 font-medium text-gray-600">Tempo Atual:</p>
                <div id="timer-display" class="text-6xl font-extrabold text-primary mb-6 tabular-nums">0.000</div>
                <div class="space-y-4">
                    <button id="start-button" onclick="startGame()" class="w-full py-3 px-6 bg-green-500 text-white font-bold rounded-lg shadow-lg hover:bg-green-600 transition duration-200 disabled:opacity-50">
                        INICIAR TENTATIVA
                    </button>
                    <button id="stop-button" onclick="stopGame()" class="w-full py-3 px-6 bg-red-500 text-white font-bold rounded-lg shadow-lg hover:bg-red-600 transition duration-200 disabled:opacity-50" disabled>
                        PARAR TENTATIVA
                    </button>
                </div>
            </div>

            <div id="result-message" class="mt-4 p-3 rounded-lg text-center font-medium" style="display: none;"></div>
            <div id="submission-status" class="mt-4 text-center text-sm text-gray-500" style="display: none;"></div>
        </div>

        <!-- Área do Ranking -->
        <div class="bg-white p-6 rounded-xl card border border-gray-100">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">Ranking dos Melhores Tempos (Única Tentativa)</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-3 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider w-1/12">#</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider w-6/12">Usuário</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider w-3/12">Melhor Tempo (s)</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider w-2/12">Seu ID</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboard-body" class="bg-white divide-y divide-gray-200">
                        <tr><td colspan="4" class="text-center py-4 text-gray-500">Carregando Ranking...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Modal de Nome de Usuário (Necessário para a primeira submissão) -->
    <div id="name-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 transition-opacity duration-300 hidden">
        <div class="bg-white p-6 rounded-xl w-full max-w-sm card">
            <h3 class="text-xl font-bold mb-4">Escolha seu Nome de Usuário</h3>
            <p class="text-sm text-gray-600 mb-4">Este nome será exibido no ranking. Você só precisa fazer isso uma vez.</p>
            <input type="text" id="username-input" maxlength="20" placeholder="Ex: AtletaVeloz" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
            <button onclick="saveUsername()" class="mt-4 w-full py-2 bg-primary text-white font-semibold rounded-lg hover:bg-blue-700 transition duration-200 disabled:opacity-50">
                Confirmar
            </button>
            <p id="username-error" class="text-red-500 text-sm mt-2" style="display: none;">O nome de usuário é obrigatório.</p>
        </div>
    </div>

    <!-- FIREBASE SETUP & JAVASCRIPT LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, limit, getDoc, collectionGroup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase variables are injected by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let userId = null;
        let username = null;
        let isAuthReady = false;
        let gameActive = false;
        let startTime = 0;
        let timerInterval;

        const LEADERBOARD_COLLECTION_PATH = `/artifacts/${appId}/public/data/leaderboard`;

        // Elementos do DOM
        const timerDisplay = document.getElementById('timer-display');
        const startButton = document.getElementById('start-button');
        const stopButton = document.getElementById('stop-button');
        const resultMessage = document.getElementById('result-message');
        const submissionStatus = document.getElementById('submission-status');
        const leaderboardBody = document.getElementById('leaderboard-body');
        const authStatus = document.getElementById('auth-status');
        const userIdDisplay = document.getElementById('user-id-display');
        const userIdValue = document.getElementById('user-id-value');
        const nameModal = document.getElementById('name-modal');
        const usernameInput = document.getElementById('username-input');
        // NOVOS elementos do Perfil
        const profileUsernameEl = document.getElementById('profile-username');
        const userBestTimeValueEl = document.getElementById('user-best-time-value');


        // Inicializa o Firebase e a Autenticação
        function initFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                // setLogLevel('debug'); // Descomente para ver logs de debug do Firestore

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        authStatus.textContent = "Status: Autenticado e pronto para usar.";
                        userIdDisplay.classList.remove('hidden');
                        userIdValue.textContent = userId;

                        // Tenta buscar o nome de usuário existente
                        await fetchUserData(userId);

                        isAuthReady = true;
                        // Inicia o listener do ranking
                        if (db) {
                            setupLeaderboardListener();
                        }
                    } else {
                        // Tenta autenticar
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                });
            } catch (error) {
                console.error("Erro ao inicializar Firebase:", error);
                authStatus.textContent = `Erro de Configuração: ${error.message}`;
            }
        }

        // Função para buscar o nome de usuário no Firestore (coleção privada)
        async function fetchUserData(uid) {
            const userDocRef = doc(db, `/artifacts/${appId}/users/${uid}/profile`, 'info');
            try {
                const docSnap = await getDoc(userDocRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    username = data.username;
                    profileUsernameEl.textContent = username; // Atualiza o nome do perfil
                    // Se o nome de usuário for encontrado, não mostra o modal
                } else {
                    profileUsernameEl.textContent = 'Defina seu nome!';
                    // Se o nome de usuário não existir, mostra o modal para o usuário escolher
                    nameModal.classList.remove('hidden');
                }
            } catch (error) {
                console.error("Erro ao buscar dados do usuário:", error);
                profileUsernameEl.textContent = 'Erro de carregamento';
                // Em caso de erro, ainda mostra o modal
                nameModal.classList.remove('hidden');
            }
        }

        // Salva o nome de usuário e fecha o modal
        window.saveUsername = async function() {
            const newUsername = usernameInput.value.trim();
            const usernameError = document.getElementById('username-error');

            if (!newUsername) {
                usernameError.style.display = 'block';
                return;
            }
            usernameError.style.display = 'none';

            if (!userId || !db) {
                showModal('Erro', 'Autenticação não concluída. Tente novamente.');
                return;
            }

            try {
                // Salva na coleção privada do usuário
                const userDocRef = doc(db, `/artifacts/${appId}/users/${userId}/profile`, 'info');
                await setDoc(userDocRef, { username: newUsername, lastUpdate: new Date() }, { merge: true });

                username = newUsername;
                profileUsernameEl.textContent = username; // Atualiza o nome do perfil
                nameModal.classList.add('hidden');
                // Se houver um resultado pendente, tenta submetê-lo
                if (parseFloat(timerDisplay.textContent) > 0 && !gameActive) {
                    submitScore(parseFloat(timerDisplay.textContent));
                }
            } catch (error) {
                console.error("Erro ao salvar nome de usuário:", error);
                showModal('Erro', `Falha ao salvar nome: ${error.message}`);
            }
        }

        // --- Lógica do Jogo/Cronômetro ---

        window.startGame = function() {
            if (!isAuthReady) {
                resultMessage.textContent = 'Aguarde a autenticação.';
                resultMessage.className = 'mt-4 p-3 rounded-lg text-center font-medium bg-yellow-100 text-yellow-700';
                resultMessage.style.display = 'block';
                return;
            }

            gameActive = true;
            startTime = Date.now();
            timerDisplay.textContent = '0.000';
            startButton.disabled = true;
            stopButton.disabled = false;
            resultMessage.style.display = 'none';
            submissionStatus.style.display = 'none';

            // Inicia o intervalo do cronômetro
            timerInterval = setInterval(() => {
                const elapsedTime = (Date.now() - startTime) / 1000;
                timerDisplay.textContent = elapsedTime.toFixed(3);
            }, 10);
        }

        window.stopGame = function() {
            if (!gameActive) return;

            clearInterval(timerInterval);
            const endTime = Date.now();
            const finalTime = (endTime - startTime) / 1000;

            timerDisplay.textContent = finalTime.toFixed(3);

            gameActive = false;
            startButton.disabled = false;
            stopButton.disabled = true;

            resultMessage.textContent = `Seu Tempo: ${finalTime.toFixed(3)} segundos.`;
            resultMessage.className = 'mt-4 p-3 rounded-lg text-center font-medium bg-blue-100 text-blue-700';
            resultMessage.style.display = 'block';

            // Submete a pontuação
            submitScore(finalTime);
        }

        // --- Lógica de Submissão e Regra Única de Ranking ---

        async function submitScore(time) {
            if (!userId || !db) {
                submissionStatus.textContent = 'Erro de submissão: Autenticação pendente.';
                submissionStatus.className = 'mt-4 text-center text-sm text-red-500';
                submissionStatus.style.display = 'block';
                return;
            }

            if (!username) {
                submissionStatus.textContent = 'Por favor, defina seu nome de usuário primeiro no pop-up.';
                submissionStatus.className = 'mt-4 text-center text-sm text-yellow-700';
                submissionStatus.style.display = 'block';
                nameModal.classList.remove('hidden');
                return;
            }

            submissionStatus.textContent = 'Verificando e submetendo sua pontuação...';
            submissionStatus.className = 'mt-4 text-center text-sm text-gray-500';
            submissionStatus.style.display = 'block';

            const userDocRef = doc(db, LEADERBOARD_COLLECTION_PATH, userId);

            try {
                const docSnap = await getDoc(userDocRef);
                const newScore = parseFloat(time.toFixed(3));
                let shouldUpdate = false;
                let message = '';

                if (docSnap.exists()) {
                    // Usuário já tem um registro. Verifica se o novo tempo é MELHOR (menor).
                    const existingData = docSnap.data();
                    const existingBestTime = existingData.bestTime;

                    if (newScore < existingBestTime) {
                        shouldUpdate = true;
                        message = `Parabéns! Seu novo tempo (${newScore}s) é melhor que o seu recorde anterior (${existingBestTime}s). Ranking atualizado!`;
                    } else {
                        // --- EDITADO: Mensagem mais clara de registro único ---
                        message = `Seu tempo atual (${newScore}s) não é melhor que seu recorde (**${existingBestTime}s**). O registro no ranking é único e não foi atualizado.`;
                    }
                } else {
                    // Novo usuário. Cria o registro.
                    shouldUpdate = true;
                    message = `Novo recorde estabelecido! Seu tempo (${newScore}s) foi adicionado ao ranking.`;
                }

                if (shouldUpdate) {
                    const dataToSave = {
                        userId: userId,
                        username: username,
                        bestTime: newScore,
                        timestamp: Date.now()
                    };

                    await setDoc(userDocRef, dataToSave);

                    submissionStatus.textContent = message;
                    submissionStatus.className = 'mt-4 text-center text-sm text-green-700';
                } else {
                    submissionStatus.textContent = message;
                    submissionStatus.className = 'mt-4 text-center text-sm text-yellow-700';
                }

            } catch (error) {
                console.error("Erro ao submeter pontuação:", error);
                submissionStatus.textContent = `Erro: Falha ao comunicar com o ranking. ${error.message}`;
                submissionStatus.className = 'mt-4 text-center text-sm text-red-500';
            }
        }

        // --- Lógica do Ranking em Tempo Real (onSnapshot) ---

        function setupLeaderboardListener() {
            const rankingRef = collection(db, LEADERBOARD_COLLECTION_PATH);
            const q = query(rankingRef); // Sem orderBy para evitar a necessidade de índice composto, faremos a ordenação no cliente.

            onSnapshot(q, (snapshot) => {
                const scores = [];
                snapshot.forEach((doc) => {
                    scores.push(doc.data());
                });

                // Ordena os scores no cliente pelo bestTime (menor tempo é melhor)
                scores.sort((a, b) => a.bestTime - b.bestTime);
                
                // --- DEBUG: Loga os scores para verificar IDs únicos ---
                console.log("Ranking de Scores (Unicos por UserId):", scores.map(s => ({ userId: s.userId, bestTime: s.bestTime })));

                // Encontra e atualiza o recorde pessoal na área de perfil
                const currentUserScore = scores.find(s => s.userId === userId);
                if (currentUserScore) {
                    userBestTimeValueEl.textContent = currentUserScore.bestTime.toFixed(3);
                } else {
                    userBestTimeValueEl.textContent = '--.--';
                }


                renderLeaderboard(scores);
            }, (error) => {
                console.error("Erro ao ouvir o ranking:", error);
                leaderboardBody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-red-500">Erro ao carregar o ranking: ${error.message}</td></tr>`;
            });
        }

        function renderLeaderboard(scores) {
            leaderboardBody.innerHTML = '';
            if (scores.length === 0) {
                leaderboardBody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-gray-500">Nenhum tempo submetido ainda. Seja o primeiro!</td></tr>`;
                return;
            }

            scores.forEach((score, index) => {
                const isCurrentUser = score.userId === userId;
                const rowClass = isCurrentUser ? 'bg-indigo-100 font-bold text-indigo-800' : 'text-gray-700';
                const row = document.createElement('tr');
                row.className = `ranking-item ${rowClass}`;
                row.innerHTML = `
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-center">${index + 1}</td>
                    <td class="px-6 py-3 whitespace-nowrap text-sm font-medium">${score.username || 'Usuário Anônimo'}</td>
                    <td class="px-6 py-3 whitespace-nowrap text-sm tabular-nums">${score.bestTime.toFixed(3)}</td>
                    <td class="px-6 py-3 whitespace-nowrap text-xs truncate">${score.userId.substring(0, 8)}...</td>
                `;
                leaderboardBody.appendChild(row);
            });
        }

        // --- Inicialização ---

        // Função simples de modal (substitui alert)
        function showModal(title, message) {
            const existingModal = document.getElementById('simple-alert-modal');
            if (existingModal) existingModal.remove();

            const modalHtml = `
                <div id="simple-alert-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100]">
                    <div class="bg-white p-6 rounded-lg shadow-2xl w-full max-w-sm">
                        <h3 class="text-xl font-bold mb-3 text-gray-800">${title}</h3>
                        <p class="text-gray-600 mb-4">${message}</p>
                        <button onclick="document.getElementById('simple-alert-modal').remove()" class="w-full py-2 bg-primary text-white font-semibold rounded-lg hover:bg-blue-700">OK</button>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        window.showModal = showModal; // Expõe para uso no HTML

        window.onload = initFirebase;

    </script>
</body>
</html>
