<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jogos de Habilidade</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .game-area {
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: 400px;
        }
        /* Estilos do Jogo de Rea√ß√£o */
        .reaction-box {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            font-weight: 800;
            font-size: 1.5rem;
            color: #fff;
            cursor: pointer;
            transition: background-color 0.1s ease-in-out;
            user-select: none;
            padding: 20px;
            border-radius: 12px;
        }
        .reaction-box.ready { background-color: #3b82f6; } 
        .reaction-box.wait { background-color: #f59e0b; cursor: not-allowed; } 
        .reaction-box.go { background-color: #10b981; } 
        .reaction-box.too-soon { background-color: #ef4444; } 
        .reaction-box.result { background-color: #6366f1; } 
        
        /* Estilos do Seletor de Jogo */
        .game-selector {
            transition: background-color 0.2s, color 0.2s, transform 0.1s;
        }
        .game-selector.active {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .game-selector:not(.active) {
            background-color: #e5e7eb; /* gray-200 */
            color: #4b5563; /* gray-600 */
        }

        /* Estilos do Teclado Customizado */
        #custom-keypad {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 50;
            background-color: #f3f4f6; /* gray-100 */
            padding: 1rem;
            border-top: 4px solid #db2777; /* pink-600 */
            box-shadow: 0 -4px 15px rgba(0, 0, 0, 0.2);
        }
        .keypad-btn {
            @apply p-4 text-2xl font-bold bg-white rounded-xl shadow-lg hover:bg-gray-200 transition duration-150 active:scale-95;
        }

        @media (min-width: 640px) {
            .reaction-box { font-size: 2.5rem; }
            .container { flex-direction: row; }
            .game-area { flex: 2; }
            .leaderboard-container { flex: 1; }
            /* Esconde o teclado customizado em telas grandes, o input deve ser usado via mouse/teclado normal */
            #custom-keypad {
                display: none !important; 
            }
        }
    </style>
</head>
<body>
    
    <div class="container">
        
        <!-- Controles de Sele√ß√£o de Jogo -->
        <div class="w-full flex justify-center gap-4 mb-4">
            <button id="btn-reaction" class="game-selector active bg-indigo-600 text-white p-3 rounded-xl font-semibold w-1/2 md:w-auto" onclick="setGameMode('reaction')">
                ‚è± Tempo de Rea√ß√£o
            </button>
            <button id="btn-guess" class="game-selector bg-gray-300 text-gray-800 p-3 rounded-xl font-semibold w-1/2 md:w-auto" onclick="setGameMode('guess')">
                üî¢ Adivinhe o N√∫mero
            </button>
        </div>

        <!-- √Årea do Jogo -->
        <div class="game-area">
            
            <!-- JOGO 1: TEMPO DE REA√á√ÉO -->
            <div id="reaction-game" class="flex flex-col flex-grow">
                <div id="reaction-box" class="reaction-box ready" onclick="handleReactionClick()">
                    Clique para Come√ßar
                </div>
            </div>

            <!-- JOGO 2: ADIVINHE O N√öMERO (Escondido por padr√£o) -->
            <div id="guess-game" class="hidden flex-col flex-grow p-6 items-center justify-center">
                <h3 class="text-3xl font-bold text-pink-600 mb-6">Adivinhe o N√∫mero</h3>
                
                <p id="guess-message" class="text-xl font-semibold text-gray-700 mb-4">
                    Tente acertar o n√∫mero secreto (1 a 100)!
                </p>
                
                <form id="guess-form" onsubmit="event.preventDefault(); submitGuess();" class="w-full max-w-xs">
                    <!-- Input agora √© readonly e type="text" para impedir o teclado nativo, usando o teclado customizado -->
                    <input type="text" id="guess-input" placeholder="Seu palpite (1-100)" readonly
                           class="w-full p-4 border-4 border-pink-300 rounded-xl focus:outline-none focus:ring-4 focus:ring-pink-500 mb-4 text-center text-2xl font-bold" 
                           onfocus="showCustomKeypad(true)" onblur="validateGuessInput()" required>
                    
                    <button type="submit" id="guess-button" class="w-full bg-pink-600 text-white p-3 rounded-xl font-semibold hover:bg-pink-700 transition duration-200 shadow-lg">
                        Chutar!
                    </button>
                </form>
                <p id="attempts-counter" class="text-base mt-4 text-gray-500">Tentativas: 0</p>
            </div>
        </div>

        <!-- Placar e Status -->
        <div class="leaderboard-container bg-white p-6 rounded-xl shadow-lg flex flex-col gap-4">
            <h2 id="leaderboard-title" class="text-2xl font-bold text-gray-800 border-b pb-2">üèÜ Placar de Tempo de Rea√ß√£o</h2>
            
            <!-- Status de Autentica√ß√£o -->
            <div id="auth-status" class="text-sm font-semibold p-2 rounded-lg">
                <span class="text-gray-500">Iniciando Firebase...</span>
            </div>

            <!-- Placar -->
            <div id="leaderboard-list" class="flex flex-col gap-3">
                <div class="text-gray-500 italic">Carregando placar...</div>
            </div>
        </div>
    </div>
    
    <!-- Custom Keypad (Para for√ßar apenas n√∫meros em dispositivos m√≥veis) -->
    <div id="custom-keypad" class="hidden">
        <div class="grid grid-cols-3 gap-3 max-w-sm mx-auto">
            <!-- Linha 1 -->
            <button type="button" class="keypad-btn" onclick="keypadInput('1')">1</button>
            <button type="button" class="keypad-btn" onclick="keypadInput('2')">2</button>
            <button type="button" class="keypad-btn" onclick="keypadInput('3')">3</button>
            <!-- Linha 2 -->
            <button type="button" class="keypad-btn" onclick="keypadInput('4')">4</button>
            <button type="button" class="keypad-btn" onclick="keypadInput('5')">5</button>
            <button type="button" class="keypad-btn" onclick="keypadInput('6')">6</button>
            <!-- Linha 3 -->
            <button type="button" class="keypad-btn" onclick="keypadInput('7')">7</button>
            <button type="button" class="keypad-btn" onclick="keypadInput('8')">8</button>
            <button type="button" class="keypad-btn" onclick="keypadInput('9')">9</button>
            <!-- Linha 4 -->
            <button type="button" class="keypad-btn bg-red-400 hover:bg-red-500 text-white" onclick="keypadInput('delete')">DEL</button>
            <button type="button" class="keypad-btn" onclick="keypadInput('0')">0</button>
            <!-- O bot√£o OK submete o formul√°rio e fecha o teclado -->
            <button type="button" class="keypad-btn bg-pink-600 hover:bg-pink-700 text-white" onclick="document.getElementById('guess-form').requestSubmit()">OK</button>
        </div>
    </div>
    
    <!-- Modal para Nickname (Escondido por padr√£o) -->
    <div id="nickname-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm transform transition-all">
            <h3 class="text-xl font-bold mb-4 text-indigo-600">Primeiro, seu Nickname</h3>
            <p class="text-gray-600 mb-6">Voc√™ precisa de um apelido para aparecer no placar.</p>
            
            <form id="nickname-form" onsubmit="event.preventDefault(); saveNickname();">
                <input type="text" id="nickname-input" placeholder="Seu Nickname (letras, n√∫meros, etc.)" maxlength="20"
                       inputmode="text"
                       class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 mb-4" required>
                
                <button type="submit" id="save-nickname-btn"
                        class="w-full bg-indigo-600 text-white p-3 rounded-lg font-semibold hover:bg-indigo-700 transition duration-200">
                    Salvar Nickname
                </button>
            </form>
            <p id="nickname-error" class="text-red-500 text-sm mt-3 hidden"></p>
        </div>
    </div>

    <!-- Modal de Recorde (Escondido por padr√£o) -->
    <div id="score-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm transform transition-all text-center">
            <h3 id="score-modal-title" class="text-2xl font-extrabold mb-2 text-green-600">Novo Recorde!</h3>
            <p id="score-modal-message" class="text-gray-700 mb-6">Parab√©ns! Seu tempo de **XXms** foi salvo.</p>
            
            <button onclick="closeScoreModal()"
                    class="bg-indigo-500 text-white p-3 rounded-lg font-semibold hover:bg-indigo-600 transition duration-200">
                Fechar
            </button>
        </div>
    </div>

    <script type="module">
        // Vari√°veis Globais do Canvas (N√ÉO DELETAR!)
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Importa√ß√µes e Inicializa√ß√£o
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, serverTimestamp, orderBy, limit, getDoc } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";
        
        // Configura√ß√£o Firebase
        let app;
        let db;
        let auth;
        let userId = null;
        let userNickname = null;
        let isAuthReady = false;

        // =================================================================================
        // FUN√á√ïES PARA FIREBASE E REGRAS DE SEGURAN√áA
        // =================================================================================

        // Cole√ß√µes para o Placar (Dados P√∫blicos/Compartilhados)
        const REACTION_COLLECTION_NAME = "reaction_leaderboard"; 
        const GUESS_COLLECTION_NAME = "guess_leaderboard"; 
        
        // Retorna a refer√™ncia do documento do perfil (privado do usu√°rio)
        const getProfileRef = (db, uid) => {
            // Caminho: /artifacts/{appId}/users/{userId}/profiles/user_details
            return doc(db, `artifacts/${appId}/users/${uid}/profiles`, "user_details");
        };

        // Retorna a refer√™ncia da cole√ß√£o do placar (p√∫blico)
        const getLeaderboardCollectionRef = (db, collectionName) => {
            // Caminho: /artifacts/{appId}/public/data/${collectionName}
            return collection(db, `artifacts/${appId}/public/data/${collectionName}`);
        };

        // Vari√°veis de Modo de Jogo
        let currentGameMode = 'reaction'; // 'reaction' ou 'guess'

        // Vari√°veis do Jogo de Rea√ß√£o
        const reactionBox = document.getElementById('reaction-box');
        let reactionStartTime, reactionEndTime;
        let isWaiting = false;
        let isGo = false;
        let timerId;
        const MIN_WAIT = 1500;
        const MAX_WAIT = 4000;

        // Vari√°veis do Jogo de Palpite
        let targetNumber = 0;
        let guessAttempts = 0;
        const guessMessage = document.getElementById('guess-message');
        const attemptsCounter = document.getElementById('attempts-counter');
        const guessInput = document.getElementById('guess-input');

        // =================================================================================
        // FUN√á√ïES DE UTILIDADE E UI
        // =================================================================================
        
        function updateAuthStatus(status, colorClass) {
            const authStatusElement = document.getElementById('auth-status');
            authStatusElement.textContent = status;
            authStatusElement.className = `text-sm font-semibold p-2 rounded-lg ${colorClass}`;
        }

        function showModal(id) {
            document.getElementById(id).classList.remove('hidden');
        }

        function hideModal(id) {
            document.getElementById(id).classList.add('hidden');
        }

        function setGameMode(mode) {
            if (currentGameMode === mode) return;

            // Esconde/Mostra as √°reas de jogo
            document.getElementById('reaction-game').classList.add('hidden');
            document.getElementById('guess-game').classList.add('hidden');
            document.getElementById('reaction-game').classList.remove('flex-col');
            document.getElementById('guess-game').classList.remove('flex-col');
            
            document.getElementById(`btn-${currentGameMode}`).classList.remove('active', 'bg-indigo-600', 'text-white', 'bg-pink-600');
            document.getElementById(`btn-${currentGameMode}`).classList.add('bg-gray-300', 'text-gray-800');
            
            // Esconde o teclado customizado ao mudar de jogo
            showCustomKeypad(false);

            currentGameMode = mode;

            document.getElementById(`btn-${mode}`).classList.add('active', `bg-${mode === 'reaction' ? 'indigo' : 'pink'}-600`, 'text-white');
            document.getElementById(`btn-${mode}`).classList.remove('bg-gray-300', 'text-gray-800');

            document.getElementById(`${mode}-game`).classList.remove('hidden');
            document.getElementById(`${mode}-game`).classList.add('flex-col');

            // Atualiza Placar e reinicia o jogo
            if (mode === 'reaction') {
                document.getElementById('leaderboard-title').textContent = 'üèÜ Placar de Tempo de Rea√ß√£o';
                if (isAuthReady) setupLeaderboardListener(REACTION_COLLECTION_NAME, "time_ms", "ms");
                resetReactionGame();
            } else { // guess
                document.getElementById('leaderboard-title').textContent = 'ü•á Placar de Adivinhe o N√∫mero (Tentativas)';
                if (isAuthReady) setupLeaderboardListener(GUESS_COLLECTION_NAME, "attempts", " tentativas");
                startGuessGame();
            }
        }
        
        // =================================================================================
        // FUN√á√ïES DE AUTENTICA√á√ÉO E FIRESTORE (INICIALIZA√á√ÉO)
        // =================================================================================

        async function initFirebase() {
            
            if (!firebaseConfig.apiKey) {
                updateAuthStatus("Erro: Configura√ß√£o do Firebase ausente.", "bg-red-100 text-red-600");
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        // Exibir apenas o Nickname no status para melhor UX, mantendo o userId para debug
                        updateAuthStatus(`Logado como: ${user.uid.substring(0, 8)}...`, "bg-green-100 text-green-600");
                        isAuthReady = true;
                        await checkUserProfile();
                        if (userNickname) {
                           // Inicia o listener do jogo padr√£o (Tempo de Rea√ß√£o) ap√≥s a autentica√ß√£o e nickname
                           setupLeaderboardListener(REACTION_COLLECTION_NAME, "time_ms", "ms");
                        }
                    } else {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                });

            } catch (error) {
                console.error("Erro ao iniciar Firebase:", error);
                updateAuthStatus(`Erro de Inicializa√ß√£o: ${error.message}`, "bg-red-100 text-red-600");
            }
        }

        // =================================================================================
        // FUN√á√ïES DE PERFIL (NICKNAME)
        // =================================================================================
        
        async function checkUserProfile() {
            if (!userId) return;
            
            const profileRef = getProfileRef(db, userId);
            
            try {
                const profileSnap = await getDoc(profileRef);
                
                if (profileSnap.exists() && profileSnap.data().nickname) {
                    userNickname = profileSnap.data().nickname;
                    // Exibir apenas o Nickname no status para melhor UX, mantendo o userId para debug
                    updateAuthStatus(`Logado: ${userNickname} (ID: ${userId.substring(0, 8)}...)`, "bg-green-100 text-green-600"); 
                    hideModal('nickname-modal');
                } else {
                    userNickname = null;
                    showModal('nickname-modal');
                }
            } catch (error) {
                console.error("Erro ao checar perfil:", error);
                // N√£o atualizar o status para n√£o sobrescrever o ID de autentica√ß√£o se for um erro de permiss√£o
            }
        }

        async function saveNickname() {
            if (!userId || !db) return;

            const input = document.getElementById('nickname-input');
            const nickname = input.value.trim();
            const errorElement = document.getElementById('nickname-error');
            const button = document.getElementById('save-nickname-btn');

            if (!nickname) return;

            button.textContent = "Salvando...";
            button.disabled = true;
            errorElement.classList.add('hidden');
            
            const profileRef = getProfileRef(db, userId);

            try {
                await setDoc(profileRef, {
                    nickname: nickname,
                    updatedAt: serverTimestamp()
                }, { merge: true });

                userNickname = nickname;
                updateAuthStatus(`Logado: ${userNickname} (ID: ${userId.substring(0, 8)}...)`, "bg-green-100 text-green-600");
                
                hideModal('nickname-modal');
                // Inicia o listener do placar para o modo atual
                const collectionName = currentGameMode === 'reaction' ? REACTION_COLLECTION_NAME : GUESS_COLLECTION_NAME;
                const field = currentGameMode === 'reaction' ? "time_ms" : "attempts";
                const unit = currentGameMode === 'reaction' ? "ms" : " tentativas";
                setupLeaderboardListener(collectionName, field, unit);

            } catch (error) {
                console.error("Erro ao salvar nickname:", error);
                errorElement.textContent = `Falha ao salvar. Tente novamente. Erro: ${error.message}`;
                errorElement.classList.remove('hidden');
            } finally {
                button.textContent = "Salvar Nickname";
                button.disabled = false;
            }
        }

        // =================================================================================
        // FUN√á√ïES DE PLACAR (LEADERBOARD) - UNIFICADAS
        // =================================================================================
        
        let unsubscribeLeaderboard = null;

        function setupLeaderboardListener(collectionName, orderByField, unit) {
            if (!db) return;
            
            // Cancela o listener anterior se houver
            if (unsubscribeLeaderboard) {
                unsubscribeLeaderboard();
                unsubscribeLeaderboard = null;
            }

            const leaderboardCollection = getLeaderboardCollectionRef(db, collectionName);
            
            // Usamos orderBy("asc") para ambos os placares, pois queremos o MENOR tempo (rea√ß√£o) 
            // e o MENOR n√∫mero de tentativas (adivinhe o n√∫mero).
            const q = query(leaderboardCollection, orderBy(orderByField, "asc"), limit(50));

            // onSnapshot: Atualiza o placar em tempo real
            unsubscribeLeaderboard = onSnapshot(q, (snapshot) => {
                const leaderboardList = document.getElementById('leaderboard-list');
                leaderboardList.innerHTML = '';
                
                if (snapshot.empty) {
                    leaderboardList.innerHTML = '<div class="text-gray-500 italic">Nenhum recorde ainda. Seja o primeiro!</div>';
                    return;
                }
                
                const uniqueScores = [];
                const seenUserIds = new Set();

                snapshot.forEach(doc => {
                    const data = doc.data();
                    
                    // Garante unicidade no placar por userId, pegando apenas o melhor resultado
                    if (!seenUserIds.has(data.userId)) {
                        seenUserIds.add(data.userId);
                        uniqueScores.push(data);
                    }
                });

                // Exibir APENAS a lista dos 10 melhores √∫nicos
                uniqueScores.slice(0, 10).forEach((data, index) => { 
                    const rank = index + 1;
                    const isCurrentUser = data.userId === userId;
                    const scoreValue = data[orderByField];
                    
                    const listItem = `
                        <div class="flex justify-between items-center p-3 rounded-lg ${isCurrentUser ? 'bg-indigo-50 border-2 border-indigo-400' : 'bg-gray-50'}">
                            <span class="font-bold text-gray-700">${rank}. ${data.nickname}</span>
                            <span class="font-extrabold ${isCurrentUser ? 'text-indigo-600' : 'text-gray-800'}">${scoreValue}${unit}</span>
                        </div>
                    `;
                    leaderboardList.innerHTML += listItem;
                });
            }, (error) => {
                console.error(`Erro ao conectar o Placar (${collectionName}):`, error);
                document.getElementById('leaderboard-list').innerHTML = `
                    <div class="text-red-500 font-bold">Erro ao conectar o Placar.</div>
                `;
            });
        }

        async function saveScore(scoreValue, collectionName, scoreField, comparisonType) {
            if (!userNickname) {
                showModal('nickname-modal');
                return;
            }
            if (!db || !userId) return;

            const leaderboardCollectionRef = getLeaderboardCollectionRef(db, collectionName);
            // O documento tem o ID do usu√°rio para garantir que cada usu√°rio s√≥ tenha um recorde
            const scoreDocRef = doc(leaderboardCollectionRef, userId);

            try {
                const docSnap = await getDoc(scoreDocRef);
                
                let shouldSave = true;
                let currentBestScore = null;
                
                if (docSnap.exists()) {
                    currentBestScore = docSnap.data()[scoreField];
                    
                    // L√≥gica para garantir que s√≥ salva se for MELHOR (menor valor)
                    if (comparisonType === 'min') {
                        if (scoreValue >= currentBestScore) {
                            shouldSave = false;
                        }
                    } 
                }
                
                // Vari√°veis para o Modal
                const title = document.getElementById('score-modal-title');
                const message = document.getElementById('score-modal-message');
                const unit = collectionName === REACTION_COLLECTION_NAME ? 'ms' : ' tentativas';

                if (shouldSave) {
                    await setDoc(scoreDocRef, {
                        [scoreField]: scoreValue, 
                        nickname: userNickname,
                        userId: userId,
                        updatedAt: serverTimestamp()
                    });

                    title.textContent = docSnap.exists() ? "NOVO RECORD!" : "Recorde Registrado!";
                    title.className = "text-2xl font-extrabold mb-2 text-green-600";
                    message.innerHTML = `Seu novo melhor tempo de **${scoreValue}${unit}** foi salvo no placar!`;

                } else {
                    title.textContent = "Tempo N√£o Registrado";
                    title.className = "text-2xl font-extrabold mb-2 text-yellow-600";
                    message.innerHTML = `Seu resultado de **${scoreValue}${unit}** n√£o superou seu recorde atual de **${currentBestScore}${unit}**. Tente de novo!`;
                }

                showModal('score-modal');
                setTimeout(closeScoreModal, 3000);

            } catch (error) {
                console.error("Erro ao salvar o score:", error);
                
                const title = document.getElementById('score-modal-title');
                const message = document.getElementById('score-modal-message');
                title.textContent = "Falha ao Salvar";
                title.className = "text-2xl font-extrabold mb-2 text-red-600";
                message.innerHTML = `N√£o foi poss√≠vel salvar seu recorde. Erro: <span class="text-sm text-red-500">${error.message}</span>`;
                showModal('score-modal');
                setTimeout(closeScoreModal, 3000);
            }
        }
        
        function closeScoreModal() {
            hideModal('score-modal');
        }

        // =================================================================================
        // L√ìGICA DO JOGO DE REA√á√ÉO
        // =================================================================================

        function resetReactionGame() {
            clearTimeout(timerId);
            isWaiting = false;
            isGo = false;
            reactionBox.className = 'reaction-box ready';
            reactionBox.textContent = 'Clique para Come√ßar';
        }

        function startReactionGame() {
            if (isWaiting || isGo) return; 

            reactionBox.className = 'reaction-box wait';
            reactionBox.textContent = 'Aguarde o VERDE...';
            isWaiting = true;

            const randomWait = Math.random() * (MAX_WAIT - MIN_WAIT) + MIN_WAIT;
            
            timerId = setTimeout(() => {
                reactionBox.className = 'reaction-box go';
                reactionBox.textContent = 'CLIQUE AGORA!';
                isWaiting = false;
                isGo = true;
                reactionStartTime = performance.now();
            }, randomWait);
        }

        window.handleReactionClick = function() {
            if (currentGameMode !== 'reaction') return;

            if (reactionBox.classList.contains('ready')) {
                startReactionGame();
            } else if (reactionBox.classList.contains('wait')) {
                clearTimeout(timerId);
                reactionBox.className = 'reaction-box too-soon';
                reactionBox.textContent = 'Muito Cedo! Clique para Tentar Novamente.';
                isWaiting = false;
                isGo = false;
            } else if (reactionBox.classList.contains('go')) {
                reactionEndTime = performance.now();
                const reactionTime = Math.round(reactionEndTime - reactionStartTime);
                
                reactionBox.className = 'reaction-box result';
                reactionBox.innerHTML = `Seu Tempo: <strong>${reactionTime} ms</strong>. <br> Clique para Tentar Novamente.`;
                
                isWaiting = false;
                isGo = false;
                
                saveScore(reactionTime, REACTION_COLLECTION_NAME, "time_ms", 'min');
                
            } else if (reactionBox.classList.contains('too-soon') || reactionBox.classList.contains('result')) {
                resetReactionGame();
            }
        }

        // =================================================================================
        // L√ìGICA DO JOGO ADIVINHE O N√öMERO E TECLADO CUSTOMIZADO
        // =================================================================================

        // Manipula√ß√£o do teclado customizado
        window.showCustomKeypad = function(show) {
            const keypad = document.getElementById('custom-keypad');
            // S√≥ mostra o teclado em modo de palpite E em telas pequenas (mobile)
            if (show && currentGameMode === 'guess' && window.innerWidth < 640) {
                keypad.classList.remove('hidden');
                document.getElementById('guess-button').disabled = false;
            } else {
                keypad.classList.add('hidden');
            }
        }

        window.keypadInput = function(value) {
            const input = document.getElementById('guess-input');
            let currentValue = input.value;

            if (value === 'delete') {
                input.value = currentValue.slice(0, -1);
            } else {
                // Impede mais de 3 d√≠gitos (m√°ximo 100)
                if (currentValue.length < 3) {
                    input.value += value;
                }
            }
            // Valida√ß√£o visual
            validateGuessInput();
            
            // Re-foca o input para manter o teclado vis√≠vel
            input.focus(); 
        }

        function validateGuessInput() {
            const input = document.getElementById('guess-input');
            const guess = parseInt(input.value);
            
            // Valida√ß√£o visual: Se o n√∫mero for maior que 100 OU for 0 (0 n√£o √© um palpite v√°lido de 1 a 100)
            if (guess > 100 || (input.value.length > 0 && guess === 0)) {
                input.classList.add('border-red-500');
                input.classList.remove('border-pink-300');
                return false;
            } else {
                input.classList.remove('border-red-500');
                input.classList.add('border-pink-300');
                return true;
            }
        }

        function startGuessGame() {
            // Reinicia o estado do jogo
            targetNumber = Math.floor(Math.random() * 100) + 1; // N√∫mero entre 1 e 100
            guessAttempts = 0;
            guessMessage.textContent = 'Tente acertar o n√∫mero secreto (1 a 100)!';
            attemptsCounter.textContent = 'Tentativas: 0';
            guessInput.value = '';
            guessInput.disabled = false;
            document.getElementById('guess-button').disabled = false;
            
            // Tenta mostrar o teclado customizado em mobile
            showCustomKeypad(true); 

            console.log("N√∫mero Secreto: ", targetNumber); // Para depura√ß√£o
        }

        window.submitGuess = function() {
            if (currentGameMode !== 'guess' || guessInput.disabled) return;

            // Garante que o valor √© um n√∫mero inteiro
            const guess = parseInt(guessInput.value);

            if (!validateGuessInput() || isNaN(guess) || guess < 1 || guess > 100) {
                guessMessage.textContent = 'Por favor, insira um n√∫mero v√°lido entre 1 e 100.';
                guessMessage.className = 'text-xl font-semibold text-red-500 mb-4';
                guessInput.value = '';
                // Mant√©m o teclado customizado aberto
                showCustomKeypad(true);
                return;
            }

            // Esconde o teclado customizado ao submeter o palpite
            showCustomKeypad(false);

            guessAttempts++;
            attemptsCounter.textContent = `Tentativas: ${guessAttempts}`;
            guessMessage.className = 'text-xl font-semibold text-gray-700 mb-4';
            
            if (guess === targetNumber) {
                guessMessage.textContent = `üéâ Parab√©ns! Voc√™ acertou o n√∫mero ${targetNumber} em ${guessAttempts} tentativas!`;
                guessMessage.className = 'text-2xl font-extrabold text-green-600 mb-4';
                guessInput.disabled = true;
                document.getElementById('guess-button').disabled = true;

                // Salva o score (menor n√∫mero de tentativas)
                saveScore(guessAttempts, GUESS_COLLECTION_NAME, "attempts", 'min');

            } else if (guess < targetNumber) {
                guessMessage.textContent = '√â MAIOR. Tente novamente!';
                guessMessage.className = 'text-xl font-semibold text-orange-500 mb-4';
            } else {
                guessMessage.textContent = '√â MENOR. Tente novamente!';
                guessMessage.className = 'text-xl font-semibold text-blue-500 mb-4';
            }
            
            guessInput.value = ''; // Limpa o input ap√≥s o chute
            // N√£o foca o input para evitar problemas de layout
        }


        // =================================================================================
        // IN√çCIO DA APLICA√á√ÉO
        // =================================================================================
        window.onload = function() {
            initFirebase();
            setGameMode('reaction'); // Define o modo inicial
            
            // Adiciona um listener global para fechar o teclado customizado quando o foco sai do input
            document.addEventListener('touchstart', (e) => {
                // Fechar o teclado customizado se o toque n√£o for no input nem no pr√≥prio teclado
                if (!document.getElementById('guess-input').contains(e.target) && !document.getElementById('custom-keypad').contains(e.target) && window.innerWidth < 640) {
                    showCustomKeypad(false);
                }
            });
        }
    </script>
</body>
</html>
