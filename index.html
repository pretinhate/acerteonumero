<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ranking Único de Melhor Tempo</title>
    <!-- Carrega Tailwind CSS para estilização rápida e responsiva -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Define a fonte Inter para toda a aplicação */
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        .card { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .ranking-item:nth-child(odd) { background-color: #f0f4f8; }
        .ranking-item:nth-child(even) { background-color: #ffffff; }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1d4ed8',
                        secondary: '#93c5fd',
                    }
                }
            }
        }
    </script>
</head>
<body class="p-4 md:p-8 min-h-screen flex flex-col items-center">

    <!-- Cabeçalho e Informações do Usuário -->
    <div class="w-full max-w-4xl mb-6 bg-white p-4 rounded-xl card border border-gray-100">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">Desafio de Tempo e Ranking Único</h1>
        <p class="text-gray-600 mb-4">Seu objetivo é conseguir o tempo mais baixo. Sua pontuação no ranking só será atualizada se for **melhor** que sua tentativa anterior.</p>
        <p id="auth-status" class="text-sm font-medium text-primary">Carregando autenticação...</p>
        <p id="user-id-display" class="text-xs text-gray-500 mt-1 break-words hidden">ID do Usuário: <span id="user-id-value" class="font-mono bg-gray-100 p-1 rounded"></span></p>
    </div>

    <main class="w-full max-w-4xl grid grid-cols-1 lg:grid-cols-2 gap-6">

        <!-- Área do Jogo/Cronômetro -->
        <div class="bg-white p-6 rounded-xl card border border-gray-100 h-fit">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">Seu Desafio</h2>

            <!-- Exibição do Recorde Pessoal/Perfil Básico -->
            <div id="user-record-display" class="mb-4 p-4 bg-blue-50 rounded-lg border border-blue-200 flex items-center space-x-4">
                <img id="profile-image-display" src="https://placehold.co/48x48/cccccc/333333?text=P" alt="" class="w-12 h-12 rounded-full border-2 border-blue-400 object-cover">
                <div>
                    <!-- Este botão/link abrirá o modal para edição -->
                    <button onclick="document.getElementById('profile-setup-modal').classList.remove('hidden')" class="text-sm font-semibold text-blue-700 mb-1 hover:underline">
                        Seu Nome: <span id="profile-username" class="font-bold text-blue-800">Carregando...</span>
                    </button>
                    <p class="text-lg font-bold text-blue-800">Seu Recorde: <span id="user-best-time-value" class="tabular-nums">--.--</span>s</p>
                    <div id="email-status-display" class="mt-1 text-sm font-medium"></div>
                </div>
            </div>

            <!-- BLOCO: Detalhes do Perfil Expandidos (com País, Bio, etc.) -->
            <div id="profile-details-expanded" class="mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
                <button onclick="toggleDetails()" class="w-full flex justify-between items-center text-sm font-semibold text-gray-700 hover:text-primary transition duration-150">
                    Detalhes do Perfil <span id="details-toggle-icon">▼</span>
                </button>
                <div id="expanded-content" class="mt-2 text-sm text-gray-600 hidden">
                    <p><strong class="text-gray-800">País:</strong> <span id="profile-country">N/A</span></p>
                    <p><strong class="text-gray-800">Nascimento:</strong> <span id="profile-dob">N/A</span></p>
                    <div class="mt-2 border-t border-gray-200 pt-2">
                        <strong class="text-gray-800">Bio:</strong>
                        <p id="profile-bio" class="italic whitespace-pre-wrap mt-1">Nenhuma biografia adicionada.</p>
                    </div>
                </div>
            </div>


            <div id="game-area" class="text-center p-8 bg-indigo-50 rounded-lg border-2 border-indigo-200">
                <p class="text-xl mb-4 font-medium text-gray-600">Tempo Atual:</p>
                <div id="timer-display" class="text-6xl font-extrabold text-primary mb-6 tabular-nums">0.000</div>
                <div class="space-y-4">
                    <button id="start-button" onclick="startGame()" class="w-full py-3 px-6 bg-green-500 text-white font-bold rounded-lg shadow-lg hover:bg-green-600 transition duration-200 disabled:opacity-50" disabled>
                        INICIAR TENTATIVA
                    </button>
                    <p id="start-blocker-message" class="text-red-500 text-sm font-semibold">Preencha seu perfil e verifique o e-mail para jogar.</p>
                    <button id="stop-button" onclick="stopGame()" class="w-full py-3 px-6 bg-red-500 text-white font-bold rounded-lg shadow-lg hover:bg-red-600 transition duration-200 disabled:opacity-50" disabled>
                        PARAR TENTATIVA
                    </button>
                </div>
            </div>

            <div id="result-message" class="mt-4 p-3 rounded-lg text-center font-medium" style="display: none;"></div>
            <div id="submission-status" class="mt-4 text-center text-sm text-gray-500" style="display: none;"></div>
        </div>

        <!-- Área do Ranking -->
        <div class="bg-white p-6 rounded-xl card border border-gray-100">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">Ranking dos Melhores Tempos (Única Tentativa)</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-3 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider w-1/12">#</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider w-1/12">Foto</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider w-5/12">Usuário</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider w-3/12">Melhor Tempo (s)</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider w-2/12">Seu ID</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboard-body" class="bg-white divide-y divide-gray-200">
                        <tr><td colspan="5" class="text-center py-4 text-gray-500">Carregando Ranking...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- MODAL DE CONFIGURAÇÃO DE PERFIL -->
    <div id="profile-setup-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 transition-opacity duration-300 hidden">
        <div class="bg-white p-6 rounded-xl w-full max-w-sm card max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold mb-4 text-gray-800">Complete seu Perfil</h3>
            <p class="text-sm text-gray-600 mb-4">Nome e E-mail são obrigatórios. Os demais campos são opcionais.</p>
            
            <label for="username-input" class="block text-sm font-medium text-gray-700 mb-1">Nome de Usuário:</label>
            <input type="text" id="username-input" maxlength="20" placeholder="Ex: AtletaVeloz" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary mb-3">

            <label for="email-input" class="block text-sm font-medium text-gray-700 mb-1">Seu E-mail:</label>
            <input type="email" id="email-input" placeholder="seu@email.com" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary mb-3">

            <!-- CAMPO PAÍS -->
            <label for="country-input" class="block text-sm font-medium text-gray-700 mb-1">País onde reside (Opcional):</label>
            <input type="text" id="country-input" placeholder="Ex: Brasil" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary mb-3">
            
            <!-- CAMPO DATA DE NASCIMENTO -->
            <label for="dob-input" class="block text-sm font-medium text-gray-700 mb-1">Data de Nascimento (Opcional):</label>
            <input type="date" id="dob-input" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary mb-3">

            <!-- CAMPO BIO -->
            <label for="bio-input" class="block text-sm font-medium text-gray-700 mb-1">Bio/Sobre Você (Máx 150 caracteres):</label>
            <textarea id="bio-input" maxlength="150" rows="3" placeholder="Conte algo sobre você..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary mb-3 resize-none"></textarea>

            <!-- Campo da Foto (Base64) -->
            <label for="profile-image-file-input" class="block text-sm font-medium text-gray-700 mb-1">Selecione uma Foto (Máx 250 KB):</label>
            <input type="file" id="profile-image-file-input" accept="image/*" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
            <p class="text-xs text-red-500 mt-1 mb-3">Aviso: Mantenha a imagem pequena (Max 250 KB) para evitar erros de limite de tamanho do banco de dados.</p>

            <button onclick="saveProfile()" class="mt-4 w-full py-2 bg-primary text-white font-semibold rounded-lg hover:bg-blue-700 transition duration-200 disabled:opacity-50">
                Confirmar Perfil
            </button>
            <p id="profile-error" class="text-red-500 text-sm mt-2" style="display: none;">O Nome de Usuário e o E-mail são obrigatórios.</p>
            
            <button onclick="openDeleteConfirmationModal()" class="mt-3 w-full py-2 bg-red-500 text-white font-semibold rounded-lg hover:bg-red-600 transition duration-200">
                Apagar Minha Conta
            </button>
        </div>
    </div>
    
    <!-- MODAL DE CONFIRMAÇÃO DE E-MAIL (Bloqueio) -->
    <div id="verification-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 transition-opacity duration-300 hidden">
        <div class="bg-white p-6 rounded-xl w-full max-w-sm card text-center">
            <h3 class="text-2xl font-bold mb-3 text-red-600">Verificação Pendente!</h3>
            <p class="text-gray-700 mb-4">Para iniciar o desafio, você precisa confirmar seu e-mail (<span id="unverified-email" class="font-semibold"></span>).</p>
            <p class="text-sm text-gray-600 mb-6">Em uma aplicação real, um e-mail de verificação seria enviado. Por favor, clique no botão abaixo para simular a conclusão da verificação e desbloquear o jogo.</p>
            
            <button onclick="confirmEmailVerification()" class="w-full py-3 bg-red-500 text-white font-semibold rounded-lg hover:bg-red-600 transition duration-200">
                CONFIRMAR VERIFICAÇÃO (Simulação)
            </button>
            <p id="verification-error" class="text-red-500 text-sm mt-2" style="display: none;"></p>
        </div>
    </div>
    
    <!-- MODAL DE CONFIRMAÇÃO DE EXCLUSÃO DE CONTA -->
    <div id="delete-confirmation-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 transition-opacity duration-300 hidden">
        <div class="bg-white p-6 rounded-xl w-full max-w-sm card text-center">
            <h3 class="text-2xl font-bold mb-3 text-red-600">Tem Certeza?</h3>
            <p class="text-gray-700 mb-4">Esta ação **apagará permanentemente** todos os seus dados do ranking e perfil. Você terá um novo ID anônimo no próximo acesso.</p>
            <p id="delete-status-message" class="text-sm text-yellow-600 mb-4" style="display: none;"></p>
            
            <button onclick="executeAccountDeletion()" class="w-full py-3 bg-red-500 text-white font-semibold rounded-lg hover:bg-red-600 transition duration-200 mb-2">
                Sim, Apagar Meus Dados
            </button>
            <button onclick="document.getElementById('delete-confirmation-modal').classList.add('hidden')" class="w-full py-3 bg-gray-300 text-gray-800 font-semibold rounded-lg hover:bg-gray-400 transition duration-200">
                Cancelar
            </button>
        </div>
    </div>


    <!-- FIREBASE SETUP & JAVASCRIPT LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Variáveis globais Firebase injetadas pelo ambiente
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // URLs Padrão para imagem (serão usadas como fallback)
        const DEFAULT_IMAGE_URL = "https://placehold.co/48x48/cccccc/333333?text=P";
        const DEFAULT_RANKING_IMG = "https://placehold.co/32x32/eeeeee/333333?text=P";
        const MAX_IMAGE_SIZE_BYTES = 250 * 1024; // 250 KB limite para Base64


        let db;
        let auth;
        let userId = null;
        let profile = {
            username: null,
            email: null,
            isEmailVerified: false,
            profileImageUrl: null, 
            country: null, 
            dob: null,     
            bio: null,     
        };
        let isAuthReady = false;
        let gameActive = false;
        let startTime = 0;
        let timerInterval;

        const LEADERBOARD_COLLECTION_PATH = `/artifacts/${appId}/public/data/leaderboard`;

        // Elementos do DOM
        const timerDisplay = document.getElementById('timer-display');
        const startButton = document.getElementById('start-button');
        const stopButton = document.getElementById('stop-button');
        const resultMessage = document.getElementById('result-message');
        const submissionStatus = document.getElementById('submission-status');
        const leaderboardBody = document.getElementById('leaderboard-body');
        const authStatus = document.getElementById('auth-status');
        const userIdDisplay = document.getElementById('user-id-display');
        const userIdValue = document.getElementById('user-id-value');
        
        // Elementos do Perfil e Modais
        const profileUsernameEl = document.getElementById('profile-username');
        const userBestTimeValueEl = document.getElementById('user-best-time-value');
        const emailStatusDisplayEl = document.getElementById('email-status-display');
        const profileSetupModal = document.getElementById('profile-setup-modal');
        const usernameInput = document.getElementById('username-input');
        const emailInput = document.getElementById('email-input');
        const profileImageFileInput = document.getElementById('profile-image-file-input');
        const profileErrorEl = document.getElementById('profile-error');
        const verificationModal = document.getElementById('verification-modal');
        const unverifiedEmailEl = document.getElementById('unverified-email');
        const startBlockerMessageEl = document.getElementById('start-blocker-message');
        const profileImageDisplayEl = document.getElementById('profile-image-display'); 
        const deleteConfirmationModal = document.getElementById('delete-confirmation-modal');
        const deleteStatusMessageEl = document.getElementById('delete-status-message');
        
        // NOVOS ELEMENTOS DE INPUT DO PERFIL
        const countryInput = document.getElementById('country-input');
        const dobInput = document.getElementById('dob-input');
        const bioInput = document.getElementById('bio-input');
        
        // NOVOS ELEMENTOS DE EXIBIÇÃO DO PERFIL
        const profileCountryEl = document.getElementById('profile-country');
        const profileDOBEl = document.getElementById('profile-dob');
        const profileBioEl = document.getElementById('profile-bio');
        const detailsToggleIcon = document.getElementById('details-toggle-icon');
        const expandedContent = document.getElementById('expanded-content');

        // Inicializa o Firebase e a Autenticação
        function initFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        authStatus.textContent = "Status: Autenticado e pronto para usar.";
                        userIdDisplay.classList.remove('hidden');
                        userIdValue.textContent = userId;

                        await fetchUserData(userId);

                        isAuthReady = true;
                        if (db) {
                            setupLeaderboardListener();
                        }
                    } else {
                        // Tenta autenticar
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                });
            } catch (error) {
                console.error("Erro ao inicializar Firebase:", error);
                authStatus.textContent = `Erro de Configuração: ${error.message}`;
            }
        }

        // Converte o objeto File para Base64 Data URL
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = (error) => reject(error);
            });
        }


        // Função para buscar o perfil completo do usuário
        async function fetchUserData(uid) {
            const userDocRef = doc(db, `/artifacts/${appId}/users/${uid}/profile`, 'info');
            try {
                const docSnap = await getDoc(userDocRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    profile.username = data.username || null;
                    profile.email = data.email || null;
                    profile.isEmailVerified = data.isEmailVerified === true; 
                    profile.profileImageUrl = data.profileImageUrl || null; 
                    profile.country = data.country || null; 
                    profile.dob = data.dob || null;         
                    profile.bio = data.bio || null;         
                }
                
                updateProfileUI();

            } catch (error) {
                console.error("Erro ao buscar dados do usuário:", error);
            }
            checkGameAccess();
        }

        // Atualiza a UI com o status do perfil
        function updateProfileUI() {
            // Seção de Cabeçalho do Perfil
            profileUsernameEl.textContent = profile.username || 'Defina seu nome!';
            profileImageDisplayEl.src = profile.profileImageUrl || DEFAULT_IMAGE_URL;
            if (!profile.profileImageUrl || profile.profileImageUrl.startsWith('http')) {
                 profileImageDisplayEl.onerror = () => { profileImageDisplayEl.src = DEFAULT_IMAGE_URL; };
            }

            if (profile.isEmailVerified) {
                emailStatusDisplayEl.innerHTML = `<span class="text-green-600">✓ E-mail (${profile.email}) verificado!</span>`;
            } else if (profile.email) {
                 emailStatusDisplayEl.innerHTML = `<span class="text-red-600">✕ E-mail (${profile.email}) **NÃO** verificado.</span>`;
            } else {
                emailStatusDisplayEl.innerHTML = `<span class="text-yellow-600">Preencha seu e-mail para verificar.</span>`;
            }
            
            // Seção de Detalhes Expandidos
            profileCountryEl.textContent = profile.country || 'Não Informado';
            
            // Formata a Data de Nascimento para exibição
            profileDOBEl.textContent = profile.dob 
                ? new Date(profile.dob + 'T00:00:00').toLocaleDateString('pt-BR') 
                : 'Não Informado';
                
            profileBioEl.textContent = profile.bio || 'Nenhuma biografia adicionada.';

            // Inputs do Modal
            usernameInput.value = profile.username || '';
            emailInput.value = profile.email || '';
            countryInput.value = profile.country || '';
            dobInput.value = profile.dob || ''; // Data de input espera YYYY-MM-DD
            bioInput.value = profile.bio || '';
        }
        
        // Função para expandir/recolher os detalhes do perfil
        window.toggleDetails = function() {
            const isHidden = expandedContent.classList.toggle('hidden');
            detailsToggleIcon.textContent = isHidden ? '▼' : '▲';
        }

        // Checa se o usuário pode começar a jogar
        function checkGameAccess() {
            if (profileSetupModal.classList.contains('hidden')) {
                profileImageFileInput.value = ''; 
            }

            if (!profile.username || !profile.email) {
                profileSetupModal.classList.remove('hidden');
                startButton.disabled = true;
                startBlockerMessageEl.textContent = 'Preencha seu perfil e verifique o e-mail para jogar.';
                startBlockerMessageEl.classList.remove('hidden');
            } else if (!profile.isEmailVerified) {
                profileSetupModal.classList.add('hidden');
                unverifiedEmailEl.textContent = profile.email;
                verificationModal.classList.remove('hidden');
                startButton.disabled = true;
                startBlockerMessageEl.textContent = 'Verificação de e-mail pendente. Clique em "Confirmar Verificação".';
                startBlockerMessageEl.classList.remove('hidden');
            } else {
                profileSetupModal.classList.add('hidden');
                verificationModal.classList.add('hidden');
                startButton.disabled = false;
                startBlockerMessageEl.classList.add('hidden');
            }
        }

        // Salva o perfil (Nome, E-mail, Detalhes e Foto LOCAL)
        window.saveProfile = async function() {
            const newUsername = usernameInput.value.trim();
            const newEmail = emailInput.value.trim();
            const newCountry = countryInput.value.trim(); 
            const newDob = dobInput.value;               
            const newBio = bioInput.value.trim();         
            const imageFile = profileImageFileInput.files[0];
            let newImageUrl = profile.profileImageUrl; 

            if (!newUsername || !newEmail) {
                profileErrorEl.textContent = 'O Nome de Usuário e o E-mail são obrigatórios.';
                profileErrorEl.style.display = 'block';
                return;
            }
            profileErrorEl.style.display = 'none';


            if (imageFile) {
                if (imageFile.size > MAX_IMAGE_SIZE_BYTES) {
                    profileErrorEl.textContent = `A imagem é muito grande. Tamanho máximo: ${MAX_IMAGE_SIZE_BYTES / 1024} KB.`;
                    profileErrorEl.style.display = 'block';
                    return;
                }

                try {
                    newImageUrl = await fileToBase64(imageFile);
                    profileImageFileInput.value = '';
                } catch (e) {
                    profileErrorEl.textContent = 'Falha ao processar a imagem. Tente outra foto.';
                    profileErrorEl.style.display = 'block';
                    return;
                }
            }
            
            if (!userId || !db) {
                showModal('Erro', 'Autenticação não concluída. Tente novamente.');
                return;
            }

            try {
                // A verificação de e-mail é resetada se o e-mail for alterado
                const isEmailChanged = profile.email !== newEmail;

                const dataToSave = { 
                    username: newUsername, 
                    email: newEmail, 
                    profileImageUrl: newImageUrl, 
                    lastUpdate: new Date(),
                    isEmailVerified: isEmailChanged ? false : profile.isEmailVerified,
                    country: newCountry, 
                    dob: newDob,         
                    bio: newBio,         
                };
                
                const userDocRef = doc(db, `/artifacts/${appId}/users/${userId}/profile`, 'info');
                await setDoc(userDocRef, dataToSave, { merge: true });

                // Atualiza o objeto profile localmente
                profile.username = newUsername;
                profile.email = newEmail;
                profile.profileImageUrl = newImageUrl;
                profile.isEmailVerified = dataToSave.isEmailVerified; 
                profile.country = newCountry; 
                profile.dob = newDob;         
                profile.bio = newBio;         

                profileSetupModal.classList.add('hidden');
                updateProfileUI(); 
                checkGameAccess(); 
                
            } catch (error) {
                console.error("Erro ao salvar perfil:", error);
                if (error.code === 'resource-exhausted') {
                    showModal('Erro Crítico', 'Falha ao salvar. Sua imagem de perfil ou bio/dados são muito grandes. Por favor, use um arquivo menor que 250 KB.');
                } else {
                    showModal('Erro', `Falha ao salvar perfil: ${error.message}`);
                }
            }
        }
        
        // Confirmação simulada da verificação de e-mail
        window.confirmEmailVerification = async function() {
             if (!userId || !db || !profile.email) {
                document.getElementById('verification-error').textContent = 'Erro de perfil. Tente recarregar.';
                return;
            }
            
            try {
                const userDocRef = doc(db, `/artifacts/${appId}/users/${userId}/profile`, 'info');
                await setDoc(userDocRef, { isEmailVerified: true, verificationDate: new Date() }, { merge: true });

                profile.isEmailVerified = true;
                
                verificationModal.classList.add('hidden');
                updateProfileUI();
                checkGameAccess(); 
                
                showModal('Sucesso!', `O e-mail ${profile.email} foi confirmado com sucesso. O jogo está liberado.`);

            } catch (error) {
                console.error("Erro ao confirmar verificação:", error);
                document.getElementById('verification-error').textContent = `Falha na confirmação: ${error.message}`;
            }
        }

        // --- Lógica de Exclusão de Conta ---

        window.openDeleteConfirmationModal = function() {
            profileSetupModal.classList.add('hidden');
            deleteConfirmationModal.classList.remove('hidden');
            deleteStatusMessageEl.style.display = 'none';
        }

        window.executeAccountDeletion = async function() {
            if (!userId || !db) {
                deleteStatusMessageEl.textContent = 'Erro de autenticação. Tente recarregar.';
                deleteStatusMessageEl.style.display = 'block';
                return;
            }

            deleteStatusMessageEl.textContent = 'Apagando dados... Por favor, aguarde.';
            deleteStatusMessageEl.style.display = 'block';

            try {
                // 1. Deletar Perfil Privado
                const profileDocRef = doc(db, `/artifacts/${appId}/users/${userId}/profile`, 'info');
                await deleteDoc(profileDocRef);

                // 2. Deletar Registro Público no Ranking
                const leaderboardDocRef = doc(db, LEADERBOARD_COLLECTION_PATH, userId);
                await deleteDoc(leaderboardDocRef);

                // 3. Logout do Usuário (Isto faz com que um novo usuário anônimo seja criado no próximo init)
                await signOut(auth);

                deleteConfirmationModal.classList.add('hidden');
                showModal('Sucesso!', 'Sua conta e todos os dados foram apagados. Você será tratado como um novo usuário no próximo acesso.');
                
                // Resetamos o estado local para garantir que a UI reflita a deleção imediatamente
                userId = null;
                profile = { username: null, email: null, isEmailVerified: false, profileImageUrl: null, country: null, dob: null, bio: null };
                updateProfileUI();
                checkGameAccess();
                
            } catch (error) {
                console.error("Erro ao apagar conta:", error);
                deleteStatusMessageEl.textContent = `Erro: Falha ao apagar dados. Tente novamente. ${error.message}`;
            }
        }


        // --- Lógica do Jogo/Cronômetro (incompleta por ser apenas um esboço) ---

        window.startGame = function() {
            if (!isAuthReady || !profile.isEmailVerified) {
                resultMessage.textContent = 'Aguarde a autenticação ou complete a verificação do e-mail.';
                resultMessage.className = 'mt-4 p-3 rounded-lg text-center font-medium bg-yellow-100 text-yellow-700';
                resultMessage.style.display = 'block';
                checkGameAccess(); 
                return;
            }

            // SIMULAÇÃO DE INÍCIO DE JOGO (sem lógica de clique ou desafio real)
            gameActive = true;
            startTime = Date.now();
            timerDisplay.textContent = '0.000';
            startButton.disabled = true;
            stopButton.disabled = false;
            resultMessage.style.display = 'none';
            submissionStatus.style.display = 'none';

            // Inicia o intervalo do cronômetro
            timerInterval = setInterval(() => {
                const elapsedTime = (Date.now() - startTime) / 1000;
                timerDisplay.textContent = elapsedTime.toFixed(3);
            }, 10);
        }

        window.stopGame = function() {
            if (!gameActive) return;

            clearInterval(timerInterval);
            const endTime = Date.now();
            const finalTime = (endTime - startTime) / 1000;

            timerDisplay.textContent = finalTime.toFixed(3);

            gameActive = false;
            startButton.disabled = false;
            stopButton.disabled = true;

            resultMessage.textContent = `Seu Tempo: ${finalTime.toFixed(3)} segundos.`;
            resultMessage.className = 'mt-4 p-3 rounded-lg text-center font-medium bg-blue-100 text-blue-700';
            resultMessage.style.display = 'block';

            // Submete a pontuação
            submitScore(finalTime);
        }

        // --- Lógica de Submissão e Regra Única de Ranking ---

        async function submitScore(time) {
            if (!userId || !db || !profile.isEmailVerified) {
                submissionStatus.textContent = 'Erro de submissão: Perfil incompleto ou não verificado.';
                submissionStatus.className = 'mt-4 text-center text-sm text-red-500';
                submissionStatus.style.display = 'block';
                return;
            }

            submissionStatus.textContent = 'Verificando e submetendo sua pontuação...';
            submissionStatus.className = 'mt-4 text-center text-sm text-gray-500';
            submissionStatus.style.display = 'block';

            const userDocRef = doc(db, LEADERBOARD_COLLECTION_PATH, userId);

            try {
                const docSnap = await getDoc(userDocRef);
                const newScore = parseFloat(time.toFixed(3));
                let shouldUpdate = false;
                let message = '';

                if (docSnap.exists()) {
                    const existingData = docSnap.data();
                    const existingBestTime = existingData.bestTime;

                    // Atualiza o recorde pessoal na UI
                    userBestTimeValueEl.textContent = existingBestTime.toFixed(3);

                    if (newScore < existingBestTime) {
                        shouldUpdate = true;
                        message = `Parabéns! Seu novo tempo (${newScore}s) é melhor que o seu recorde anterior (${existingBestTime}s). Ranking atualizado!`;
                    } else {
                        message = `Seu tempo atual (${newScore}s) não é melhor que seu recorde (**${existingBestTime}s**). O registro no ranking é único e não foi atualizado.`;
                    }
                } else {
                    shouldUpdate = true;
                    message = `Novo recorde estabelecido! Seu tempo (${newScore}s) foi adicionado ao ranking.`;
                }

                if (shouldUpdate) {
                    const dataToSave = {
                        userId: userId,
                        username: profile.username, 
                        profileImageUrl: profile.profileImageUrl,
                        bestTime: newScore,
                        timestamp: Date.now()
                    };

                    await setDoc(userDocRef, dataToSave);

                    submissionStatus.textContent = message;
                    submissionStatus.className = 'mt-4 text-center text-sm text-green-700';
                    // Atualiza o recorde pessoal na UI imediatamente após o salvamento
                    userBestTimeValueEl.textContent = newScore.toFixed(3);

                } else {
                    submissionStatus.textContent = message;
                    submissionStatus.className = 'mt-4 text-center text-sm text-yellow-700';
                }

            } catch (error) {
                console.error("Erro ao submeter pontuação:", error);
                submissionStatus.textContent = `Erro: Falha ao comunicar com o ranking. ${error.message}`;
                submissionStatus.className = 'mt-4 text-center text-sm text-red-500';
            }
        }

        // --- Lógica do Ranking em Tempo Real (onSnapshot) ---

        function setupLeaderboardListener() {
            const rankingRef = collection(db, LEADERBOARD_COLLECTION_PATH);
            // NÃO USAR orderBy no query, pois requer índices que não podemos garantir aqui.
            const q = query(rankingRef); 

            onSnapshot(q, (snapshot) => {
                const scores = [];
                snapshot.forEach((doc) => {
                    scores.push(doc.data());
                });

                // Ordena os scores no cliente pelo bestTime (menor tempo é melhor)
                scores.sort((a, b) => a.bestTime - b.bestTime);
                
                const currentUserScore = scores.find(s => s.userId === userId);
                if (currentUserScore) {
                    // Atualiza o recorde pessoal na UI com o dado do ranking
                    userBestTimeValueEl.textContent = currentUserScore.bestTime.toFixed(3);
                } else if (userId) {
                    // Se o usuário está autenticado, mas não tem score, mostra o padrão
                    userBestTimeValueEl.textContent = '--.--';
                }

                renderLeaderboard(scores);
            }, (error) => {
                console.error("Erro ao ouvir o ranking:", error);
                leaderboardBody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-red-500">Erro ao carregar o ranking: ${error.message}</td></tr>`;
            });
        }

        function renderLeaderboard(scores) {
            leaderboardBody.innerHTML = '';
            if (scores.length === 0) {
                leaderboardBody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-gray-500">Nenhum tempo submetido ainda. Seja o primeiro!</td></tr>`;
                return;
            }

            scores.forEach((score, index) => {
                const isCurrentUser = score.userId === userId;
                const rowClass = isCurrentUser ? 'bg-indigo-100 font-bold text-indigo-800' : 'text-gray-700';
                const row = document.createElement('tr');
                row.className = `ranking-item ${rowClass}`;
                
                const imageUrl = score.profileImageUrl || DEFAULT_RANKING_IMG;

                row.innerHTML = `
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-center">${index + 1}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-center">
                        <img src="${imageUrl}" onerror="this.src='${DEFAULT_RANKING_IMG}'" alt="" class="w-8 h-8 rounded-full object-cover mx-auto border-2 border-transparent ${isCurrentUser ? 'border-indigo-400' : ''}">
                    </td>
                    <td class="px-6 py-3 whitespace-nowrap text-sm font-medium">${score.username || 'Usuário Anônimo'}</td>
                    <td class="px-6 py-3 whitespace-nowrap text-sm tabular-nums">${score.bestTime.toFixed(3)}</td>
                    <td class="px-6 py-3 whitespace-nowrap text-xs truncate">${score.userId.substring(0, 8)}...</td>
                `;
                leaderboardBody.appendChild(row);
            });
        }

        // --- Inicialização e Utilidades ---

        // Função simples de modal (substitui alert)
        function showModal(title, message) {
            const existingModal = document.getElementById('simple-alert-modal');
            if (existingModal) existingModal.remove();

            const modalHtml = `
                <div id="simple-alert-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100]">
                    <div class="bg-white p-6 rounded-lg shadow-2xl w-full max-w-sm">
                        <h3 class="text-xl font-bold mb-3 text-gray-800">${title}</h3>
                        <p class="text-gray-600 mb-4">${message}</p>
                        <button onclick="document.getElementById('simple-alert-modal').remove()" class="w-full py-2 bg-primary text-white font-semibold rounded-lg hover:bg-blue-700">OK</button>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        window.showModal = showModal; 

        window.onload = initFirebase;

    </script>
</body>
</html>
